(function() {
  var Aligner, Range, _,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Range = require('atom').Range;

  _ = require('lodash');

  module.exports = Aligner = (function() {
    function Aligner(editor, spaceChars, matcher, addSpacePostfix) {
      this.editor = editor;
      this.spaceChars = spaceChars;
      this.matcher = matcher;
      this.addSpacePostfix = addSpacePostfix;
      this.align = bind(this.align, this);
      this.__computeRows = bind(this.__computeRows, this);
      this.__computeLength = bind(this.__computeLength, this);
      this.__generateAlignmentList = bind(this.__generateAlignmentList, this);
      this.__getRows = bind(this.__getRows, this);
      this.rows = [];
      this.alignments = [];
    }

    Aligner.prototype.__getRows = function() {
      var allCursors, cursor, cursors, j, k, l, len1, len2, len3, m, o, range, ranges, row, rowNums, t;
      rowNums = [];
      allCursors = [];
      cursors = _.filter(this.editor.getCursors(), function(cursor) {
        var row;
        allCursors.push(cursor);
        row = cursor.getBufferRow();
        if (cursor.visible && !_.contains(rowNums, row)) {
          rowNums.push(row);
          return true;
        }
      });
      if (cursors.length > 1) {
        this.mode = "cursor";
        for (j = 0, len1 = cursors.length; j < len1; j++) {
          cursor = cursors[j];
          row = cursor.getBufferRow();
          t = this.editor.lineTextForBufferRow(row);
          l = this.__computeLength(t.substring(0, cursor.getBufferColumn()));
          o = {
            text: t,
            length: t.length,
            row: row,
            column: l,
            cursor: cursor,
            virtualColumn: cursor.getBufferColumn()
          };
          this.rows.push(o);
        }
      } else {
        ranges = this.editor.getSelectedBufferRanges();
        for (k = 0, len2 = ranges.length; k < len2; k++) {
          range = ranges[k];
          rowNums = rowNums.concat(_.filter(range.getRows(), function(rangeRow) {
            return !rowNums.includes(rangeRow);
          }));
          if (range.end.column === 0) {
            rowNums.pop();
          }
        }
        for (m = 0, len3 = rowNums.length; m < len3; m++) {
          row = rowNums[m];
          o = {
            text: this.editor.lineTextForBufferRow(row),
            length: this.editor.lineTextForBufferRow(row).length,
            row: row
          };
          this.rows.push(o);
        }
        this.mode = "align";
      }
      if (this.mode !== "cursor") {
        return this.rows.forEach(function(o) {
          var firstCharIdx;
          t = o.text.replace(/\s/g, '');
          if (t.length > 0) {
            firstCharIdx = o.text.indexOf(t.charAt(0));
            return o.text = o.text.substr(0, firstCharIdx) + o.text.substring(firstCharIdx).replace(/\ {2,}/g, ' ');
          }
        });
      }
    };

    Aligner.prototype.__getAllIndexes = function(string, val, indexes) {
      var found, i;
      found = [];
      i = 0;
      while (true) {
        i = string.indexOf(val, i);
        if (i !== -1 && !_.some(indexes, {
          index: i
        })) {
          found.push({
            found: val,
            index: i
          });
        }
        if (i === -1) {
          break;
        }
        i++;
      }
      return found;
    };

    Aligner.prototype.__generateAlignmentList = function() {
      if (this.mode === "cursor") {
        return _.forEach(this.rows, (function(_this) {
          return function(o) {
            var part;
            part = o.text.substring(o.virtualColumn);
            _.forEach(_this.spaceChars, function(char) {
              var idx;
              idx = part.indexOf(char);
              if (idx === 0 && o.text.charAt(o.virtualColumn) !== " ") {
                o.addSpacePrefix = true;
                o.spaceCharLength = char.length;
                return false;
              }
            });
          };
        })(this));
      } else {
        _.forEach(this.rows, (function(_this) {
          return function(o) {
            _.forEach(_this.matcher, function(possibleMatcher) {
              return _this.alignments = _this.alignments.concat(_this.__getAllIndexes(o.text, possibleMatcher, _this.alignments));
            });
            if (_this.alignments.length > 0) {
              return false;
            } else {
              return true;
            }
          };
        })(this));
        this.alignments = this.alignments.sort(function(a, b) {
          return a.index - b.index;
        });
        this.alignments = _.pluck(this.alignments, "found");
      }
    };

    Aligner.prototype.__computeLength = function(s) {
      var char, diff, idx, j, len1, tabLength, tabs;
      diff = tabs = idx = 0;
      tabLength = this.editor.getTabLength();
      for (j = 0, len1 = s.length; j < len1; j++) {
        char = s[j];
        if (char === "\t") {
          diff += tabLength - (idx % tabLength);
          idx += tabLength - (idx % tabLength);
          tabs++;
        } else {
          idx++;
        }
      }
      return s.length + diff - tabs;
    };

    Aligner.prototype.__computeRows = function() {
      var addSpacePrefix, idx, matched, max, possibleMatcher;
      max = 0;
      if (this.mode === "align" || this.mode === "break") {
        matched = null;
        idx = -1;
        possibleMatcher = this.alignments.shift();
        addSpacePrefix = this.spaceChars.indexOf(possibleMatcher) > -1;
        this.rows.forEach((function(_this) {
          return function(o) {
            var backslash, blankPos, c, charFound, doubleQuotationMark, found, l, len, line, next, quotationMark, splitString;
            o.splited = null;
            if (!o.done) {
              line = o.text;
              if (line.indexOf(possibleMatcher, o.nextPos) !== -1) {
                matched = possibleMatcher;
                idx = line.indexOf(matched, o.nextPos);
                len = matched.length;
                if (_this.mode === "break") {
                  idx += len - 1;
                  c = "";
                  blankPos = -1;
                  quotationMark = doubleQuotationMark = 0;
                  backslash = charFound = false;
                  while (true) {
                    if (c === void 0) {
                      break;
                    }
                    c = line[++idx];
                    if (c === "'" && !backslash) {
                      quotationMark++;
                    }
                    if (c === '"' && !backslash) {
                      doubleQuotationMark++;
                    }
                    backslash = c === "\\" && !backslash ? true : false;
                    charFound = c !== " " && !charFound ? true : charFound;
                    if (c === " " && quotationMark % 2 === 0 && doubleQuotationMark % 2 === 0 && charFound) {
                      blankPos = idx;
                      break;
                    }
                  }
                  idx = blankPos;
                }
                next = _this.mode === "break" ? 1 : len;
                if (idx !== -1) {
                  splitString = [line.substring(0, idx), line.substring(idx + next)];
                  o.splited = splitString;
                  l = _this.__computeLength(splitString[0]);
                  if (max <= l) {
                    max = l;
                    if (l > 0 && addSpacePrefix && splitString[0].charAt(splitString[0].length - 1) !== " ") {
                      max++;
                    }
                  }
                }
              }
              found = false;
              _.forEach(_this.alignments, function(nextPossibleMatcher) {
                if (line.indexOf(nextPossibleMatcher, idx + len) !== -1) {
                  found = true;
                  return false;
                }
              });
              o.stop = !found;
            }
          };
        })(this));
        if (max >= 0) {
          if (max > 0) {
            max++;
          }
          this.rows.forEach((function(_this) {
            return function(o) {
              var diff, splitString;
              if (!o.done && o.splited && matched) {
                splitString = o.splited;
                diff = max - _this.__computeLength(splitString[0]);
                if (diff > 0) {
                  splitString[0] = splitString[0] + Array(diff).join(' ');
                }
                if (_this.addSpacePostfix && addSpacePrefix) {
                  splitString[1] = " " + splitString[1].trim();
                }
                if (_this.mode === "break") {
                  _.forEach(splitString, function(s, i) {
                    return splitString[i] = s.trim();
                  });
                  o.text = splitString.join("\n");
                } else {
                  o.text = splitString.join(matched);
                }
                o.done = o.stop;
                o.nextPos = splitString[0].length + matched.length;
              }
            };
          })(this));
        }
        return this.alignments.length > 0;
      } else {
        this.rows.forEach(function(o) {
          var part;
          if (max <= o.column) {
            max = o.column;
            part = o.text.substring(0, o.virtualColumn);
            if (part.length > 0 && o.addSpacePrefix && part.charAt(part.length - 1) !== " ") {
              max++;
            }
          }
        });
        max++;
        this.rows.forEach((function(_this) {
          return function(o) {
            var diff, line, splitString;
            line = o.text;
            splitString = [line.substring(0, o.virtualColumn), line.substring(o.virtualColumn)];
            diff = max - _this.__computeLength(splitString[0]);
            if (diff > 0) {
              splitString[0] = splitString[0] + Array(diff).join(' ');
            }
            if (o.spaceCharLength == null) {
              o.spaceCharLength = 0;
            }
            splitString[1] = splitString[1].substring(0, o.spaceCharLength) + splitString[1].substr(o.spaceCharLength).trim();
            if (_this.addSpacePostfix && o.addSpacePrefix) {
              splitString[1] = splitString[1].substring(0, o.spaceCharLength) + " " + splitString[1].substr(o.spaceCharLength);
            }
            o.text = splitString.join("");
          };
        })(this));
        return false;
      }
    };

    Aligner.prototype.align = function(multiple) {
      var checkpoint, cont;
      this.__getRows();
      this.__generateAlignmentList();
      if (this.rows.length === 1 && multiple) {
        this.mode = "break";
      }
      if (multiple || this.mode === "break") {
        while (true) {
          cont = this.__computeRows();
          if (!cont) {
            break;
          }
        }
      } else {
        this.__computeRows();
      }
      checkpoint = this.editor.createCheckpoint();
      this.rows.forEach((function(_this) {
        return function(o) {
          _this.editor.setTextInBufferRange([[o.row, 0], [o.row, o.length]], o.text);
          if (o.cursor) {
            return o.cursor.setBufferPosition([o.row, o.virtualColumn + (o.text.length - o.length)]);
          }
        };
      })(this));
      return this.editor.groupChangesSinceCheckpoint(checkpoint);
    };

    return Aligner;

  })();

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiL1VzZXJzL3N1ZHByYXdhdC8uYXRvbS9wYWNrYWdlcy9hdG9tLWFsaWdubWVudC9saWIvYWxpZ25lci5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFBQSxNQUFBLGlCQUFBO0lBQUE7O0VBQUMsUUFBUyxPQUFBLENBQVEsTUFBUjs7RUFFVixDQUFBLEdBQUksT0FBQSxDQUFRLFFBQVI7O0VBRUosTUFBTSxDQUFDLE9BQVAsR0FDVTtJQUVXLGlCQUFDLE1BQUQsRUFBVSxVQUFWLEVBQXVCLE9BQXZCLEVBQWlDLGVBQWpDO01BQUMsSUFBQyxDQUFBLFNBQUQ7TUFBUyxJQUFDLENBQUEsYUFBRDtNQUFhLElBQUMsQ0FBQSxVQUFEO01BQVUsSUFBQyxDQUFBLGtCQUFEOzs7Ozs7TUFDMUMsSUFBQyxDQUFBLElBQUQsR0FBUTtNQUNSLElBQUMsQ0FBQSxVQUFELEdBQWM7SUFGTDs7c0JBS2IsU0FBQSxHQUFXLFNBQUE7QUFDUCxVQUFBO01BQUEsT0FBQSxHQUFVO01BQ1YsVUFBQSxHQUFhO01BQ2IsT0FBQSxHQUFVLENBQUMsQ0FBQyxNQUFGLENBQVMsSUFBQyxDQUFBLE1BQU0sQ0FBQyxVQUFSLENBQUEsQ0FBVCxFQUErQixTQUFDLE1BQUQ7QUFDckMsWUFBQTtRQUFBLFVBQVUsQ0FBQyxJQUFYLENBQWdCLE1BQWhCO1FBQ0EsR0FBQSxHQUFNLE1BQU0sQ0FBQyxZQUFQLENBQUE7UUFDTixJQUFHLE1BQU0sQ0FBQyxPQUFQLElBQWtCLENBQUMsQ0FBQyxDQUFDLFFBQUYsQ0FBVyxPQUFYLEVBQW9CLEdBQXBCLENBQXRCO1VBQ0ksT0FBTyxDQUFDLElBQVIsQ0FBYSxHQUFiO0FBQ0EsaUJBQU8sS0FGWDs7TUFIcUMsQ0FBL0I7TUFPVixJQUFJLE9BQU8sQ0FBQyxNQUFSLEdBQWlCLENBQXJCO1FBQ0ksSUFBQyxDQUFBLElBQUQsR0FBUTtBQUNSLGFBQUEsMkNBQUE7O1VBQ0ksR0FBQSxHQUFN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QUFBLGFBQUQsQ0FBQSxFQUxKOztNQU9BLFVBQUEsR0FBYSxJQUFDLENBQUEsTUFBTSxDQUFDLGdCQUFSLENBQUE7TUFDYixJQUFDLENBQUEsSUFBSSxDQUFDLE9BQU4sQ0FBYyxDQUFBLFNBQUEsS0FBQTtlQUFBLFNBQUMsQ0FBRDtVQUNWLEtBQUMsQ0FBQSxNQUFNLENBQUMsb0JBQVIsQ0FBNkIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFILEVBQVEsQ0FBUixDQUFELEVBQVksQ0FBQyxDQUFDLENBQUMsR0FBSCxFQUFRLENBQUMsQ0FBQyxNQUFWLENBQVosQ0FBN0IsRUFBNkQsQ0FBQyxDQUFDLElBQS9EO1VBQ0EsSUFBRyxDQUFDLENBQUMsTUFBTDttQkFDSSxDQUFDLENBQUMsTUFBTSxDQUFDLGlCQUFULENBQTJCLENBQUMsQ0FBQyxDQUFDLEdBQUgsRUFBUSxDQUFDLENBQUMsYUFBRixHQUFrQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBUCxHQUFnQixDQUFDLENBQUMsTUFBbkIsQ0FBMUIsQ0FBM0IsRUFESjs7UUFGVTtNQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBZDthQUlBLElBQUMsQ0FBQSxNQUFNLENBQUMsMkJBQVIsQ0FBb0MsVUFBcEM7SUFsQkc7Ozs7O0FBeE5mIiwic291cmNlc0NvbnRlbnQiOlsie1JhbmdlfSA9IHJlcXVpcmUgJ2F0b20nXG5cbl8gPSByZXF1aXJlICdsb2Rhc2gnXG5cbm1vZHVsZS5leHBvcnRzID1cbiAgICBjbGFzcyBBbGlnbmVyXG4gICAgICAgICMgUHVibGljXG4gICAgICAgIGNvbnN0cnVjdG9yOiAoQGVkaXRvciwgQHNwYWNlQ2hhcnMsIEBtYXRjaGVyLCBAYWRkU3BhY2VQb3N0Zml4KSAtPlxuICAgICAgICAgICAgQHJvd3MgPSBbXVxuICAgICAgICAgICAgQGFsaWdubWVudHMgPSBbXVxuXG4gICAgICAgICMgUHJpdmF0ZVxuICAgICAgICBfX2dldFJvd3M6ID0+XG4gICAgICAgICAgICByb3dOdW1zID0gW11cbiAgICAgICAgICAgIGFsbEN1cnNvcnMgPSBbXVxuICAgICAgICAgICAgY3Vyc29ycyA9IF8uZmlsdGVyIEBlZGl0b3IuZ2V0Q3Vyc29ycygpLCAoY3Vyc29yKSAtPlxuICAgICAgICAgICAgICAgIGFsbEN1cnNvcnMucHVzaChjdXJzb3IpXG4gICAgICAgICAgICAgICAgcm93ID0gY3Vyc29yLmdldEJ1ZmZlclJvdygpXG4gICAgICAgICAgICAgICAgaWYgY3Vyc29yLnZpc2libGUgJiYgIV8uY29udGFpbnMocm93TnVtcywgcm93KVxuICAgICAgICAgICAgICAgICAgICByb3dOdW1zLnB1c2gocm93KVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZVxuXG4gICAgICAgICAgICBpZiAoY3Vyc29ycy5sZW5ndGggPiAxKVxuICAgICAgICAgICAgICAgIEBtb2RlID0gXCJjdXJzb3JcIlxuICAgICAgICAgICAgICAgIGZvciBjdXJzb3IgaW4gY3Vyc29yc1xuICAgICAgICAgICAgICAgICAgICByb3cgPSBjdXJzb3IuZ2V0QnVmZmVyUm93KClcbiAgICAgICAgICAgICAgICAgICAgdCA9IEBlZGl0b3IubGluZVRleHRGb3JCdWZmZXJSb3cocm93KVxuICAgICAgICAgICAgICAgICAgICBsID0gQF9fY29tcHV0ZUxlbmd0aCh0LnN1YnN0cmluZygwLGN1cnNvci5nZXRCdWZmZXJDb2x1bW4oKSkpXG4gICAgICAgICAgICAgICAgICAgIG8gPVxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCAgIDogdFxuICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoIDogdC5sZW5ndGhcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvdyAgICA6IHJvd1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uIDogbFxuICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yIDogY3Vyc29yXG4gICAgICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsQ29sdW1uOiBjdXJzb3IuZ2V0QnVmZmVyQ29sdW1uKClcbiAgICAgICAgICAgICAgICAgICAgQHJvd3MucHVzaCAobylcblxuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIHJhbmdlcyA9IEBlZGl0b3IuZ2V0U2VsZWN0ZWRCdWZmZXJSYW5nZXMoKVxuICAgICAgICAgICAgICAgIGZvciByYW5nZSBpbiByYW5nZXNcbiAgICAgICAgICAgICAgICAgICAgcm93TnVtcyA9IHJvd051bXMuY29uY2F0KFxuICAgICAgICAgICAgICAgICAgICAgICAgXy5maWx0ZXIgcmFuZ2UuZ2V0Um93cygpLCAocmFuZ2VSb3cpIC0+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFyb3dOdW1zLmluY2x1ZGVzKHJhbmdlUm93KVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIHJvd051bXMucG9wKCkgaWYgcmFuZ2UuZW5kLmNvbHVtbiA9PSAwXG5cbiAgICAgICAgICAgICAgICBmb3Igcm93IGluIHJvd051bXNcbiAgICAgICAgICAgICAgICAgICAgbyA9XG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ICAgOiBAZWRpdG9yLmxpbmVUZXh0Rm9yQnVmZmVyUm93KHJvdylcbiAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aCA6IEBlZGl0b3IubGluZVRleHRGb3JCdWZmZXJSb3cocm93KS5sZW5ndGhcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvdyAgICA6IHJvd1xuICAgICAgICAgICAgICAgICAgICBAcm93cy5wdXNoIChvKVxuXG4gICAgICAgICAgICAgICAgQG1vZGUgPSBcImFsaWduXCJcblxuICAgICAgICAgICAgaWYgQG1vZGUgIT0gXCJjdXJzb3JcIlxuICAgICAgICAgICAgICAgIEByb3dzLmZvckVhY2ggKG8pIC0+XG4gICAgICAgICAgICAgICAgICAgIHQgPSBvLnRleHQucmVwbGFjZSgvXFxzL2csICcnKVxuICAgICAgICAgICAgICAgICAgICBpZiB0Lmxlbmd0aCA+IDBcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0Q2hhcklkeCA9IG8udGV4dC5pbmRleE9mKHQuY2hhckF0KDApKVxuICAgICAgICAgICAgICAgICAgICAgICAgby50ZXh0ID0gby50ZXh0LnN1YnN0cigwLGZpcnN0Q2hhcklkeCkgKyBvLnRleHQuc3Vic3RyaW5nKGZpcnN0Q2hhcklkeCkucmVwbGFjZSgvXFwgezIsfS9nLCAnICcpXG5cbiAgICAgICAgX19nZXRBbGxJbmRleGVzOiAoc3RyaW5nLCB2YWwsIGluZGV4ZXMpIC0+XG4gICAgICAgICAgICBmb3VuZCA9IFtdXG4gICAgICAgICAgICBpID0gMFxuICAgICAgICAgICAgbG9vcFxuICAgICAgICAgICAgICAgIGkgPSBzdHJpbmcuaW5kZXhPZih2YWwsIGkpXG4gICAgICAgICAgICAgICAgaWYgaSAhPSAtMSAmJiAhXy5zb21lKGluZGV4ZXMsIHtpbmRleDppfSlcbiAgICAgICAgICAgICAgICAgICAgZm91bmQucHVzaCh7Zm91bmQ6dmFsLGluZGV4Oml9KVxuXG4gICAgICAgICAgICAgICAgYnJlYWsgaWYgaSA9PSAtMVxuICAgICAgICAgICAgICAgIGkrK1xuICAgICAgICAgICAgcmV0dXJuIGZvdW5kXG5cbiAgICAgICAgI2dlbmVyYXRlIHRoZSBzZXF1ZW5jZSBvZiBhbGlnbm1lbnQgY2hhcmFjdGVycyBjb21wdXRlZCBmcm9tIHRoZSBmaXJzdCBtYXRjaGluZyBsaW5lXG4gICAgICAgIF9fZ2VuZXJhdGVBbGlnbm1lbnRMaXN0OiAoKSA9PlxuICAgICAgICAgICAgaWYgQG1vZGUgPT0gXCJjdXJzb3JcIlxuICAgICAgICAgICAgICAgIF8uZm9yRWFjaCBAcm93cywgKG8pID0+XG4gICAgICAgICAgICAgICAgICAgIHBhcnQgPSBvLnRleHQuc3Vic3RyaW5nKG8udmlydHVhbENvbHVtbilcbiAgICAgICAgICAgICAgICAgICAgXy5mb3JFYWNoIEBzcGFjZUNoYXJzLCAoY2hhcikgLT5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlkeCA9IHBhcnQuaW5kZXhPZihjaGFyKVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgaWR4ID09IDAgJiYgby50ZXh0LmNoYXJBdChvLnZpcnR1YWxDb2x1bW4pICE9IFwiIFwiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgby5hZGRTcGFjZVByZWZpeCA9IHRydWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvLnNwYWNlQ2hhckxlbmd0aCA9IGNoYXIubGVuZ3RoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIF8uZm9yRWFjaCBAcm93cywgKG8pID0+XG4gICAgICAgICAgICAgICAgICAgIF8uZm9yRWFjaCBAbWF0Y2hlciwgKHBvc3NpYmxlTWF0Y2hlcikgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgIEBhbGlnbm1lbnRzID0gQGFsaWdubWVudHMuY29uY2F0IChAX19nZXRBbGxJbmRleGVzIG8udGV4dCwgcG9zc2libGVNYXRjaGVyLCBAYWxpZ25tZW50cylcblxuICAgICAgICAgICAgICAgICAgICBpZiBAYWxpZ25tZW50cy5sZW5ndGggPiAwXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2UgIyBleGl0IGlmIHdlIGdvdCBhbGwgYWxpZ25tZW50cyBjaGFyYWN0ZXJzIGluIHRoZSByb3dcbiAgICAgICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWUgIyBjb250aW51ZVxuICAgICAgICAgICAgICAgIEBhbGlnbm1lbnRzID0gQGFsaWdubWVudHMuc29ydCAoYSwgYikgLT4gYS5pbmRleCAtIGIuaW5kZXhcbiAgICAgICAgICAgICAgICBAYWxpZ25tZW50cyA9IF8ucGx1Y2sgQGFsaWdubWVudHMsIFwiZm91bmRcIlxuICAgICAgICAgICAgICAgIHJldHVyblxuXG4gICAgICAgIF9fY29tcHV0ZUxlbmd0aDogKHMpID0+XG4gICAgICAgICAgICBkaWZmID0gdGFicyA9IGlkeCA9IDBcbiAgICAgICAgICAgIHRhYkxlbmd0aCA9IEBlZGl0b3IuZ2V0VGFiTGVuZ3RoKClcbiAgICAgICAgICAgIGZvciBjaGFyIGluIHNcbiAgICAgICAgICAgICAgICBpZiBjaGFyID09IFwiXFx0XCJcbiAgICAgICAgICAgICAgICAgICAgZGlmZiArPSB0YWJMZW5ndGggLSAoaWR4ICUgdGFiTGVuZ3RoKVxuICAgICAgICAgICAgICAgICAgICBpZHggKz0gdGFiTGVuZ3RoIC0gKGlkeCAlIHRhYkxlbmd0aClcbiAgICAgICAgICAgICAgICAgICAgdGFicysrXG4gICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICBpZHgrK1xuXG4gICAgICAgICAgICByZXR1cm4gcy5sZW5ndGgrZGlmZi10YWJzXG5cbiAgICAgICAgX19jb21wdXRlUm93czogKCkgPT5cbiAgICAgICAgICAgIG1heCA9IDBcbiAgICAgICAgICAgIGlmIEBtb2RlID09IFwiYWxpZ25cIiB8fCBAbW9kZSA9PSBcImJyZWFrXCJcbiAgICAgICAgICAgICAgICBtYXRjaGVkID0gbnVsbFxuICAgICAgICAgICAgICAgIGlkeCA9IC0xXG4gICAgICAgICAgICAgICAgcG9zc2libGVNYXRjaGVyID0gQGFsaWdubWVudHMuc2hpZnQoKVxuICAgICAgICAgICAgICAgIGFkZFNwYWNlUHJlZml4ID0gQHNwYWNlQ2hhcnMuaW5kZXhPZihwb3NzaWJsZU1hdGNoZXIpID4gLTFcbiAgICAgICAgICAgICAgICBAcm93cy5mb3JFYWNoIChvKSA9PlxuICAgICAgICAgICAgICAgICAgICBvLnNwbGl0ZWQgPSBudWxsXG4gICAgICAgICAgICAgICAgICAgIGlmICFvLmRvbmVcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmUgPSBvLnRleHRcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsaW5lLmluZGV4T2YocG9zc2libGVNYXRjaGVyLCBvLm5leHRQb3MpICE9IC0xKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZWQgPSBwb3NzaWJsZU1hdGNoZXJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZHggPSBsaW5lLmluZGV4T2YobWF0Y2hlZCwgby5uZXh0UG9zKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbiA9IG1hdGNoZWQubGVuZ3RoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgQG1vZGUgPT0gXCJicmVha1wiXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkeCArPSBsZW4tMVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjID0gXCJcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBibGFua1BvcyA9IC0xXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1b3RhdGlvbk1hcmsgPSBkb3VibGVRdW90YXRpb25NYXJrID0gMFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWNrc2xhc2ggPSBjaGFyRm91bmQgPSBmYWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb29wXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBpZiBjID09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYyA9IGxpbmVbKytpZHhdXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBjID09IFwiJ1wiIGFuZCAhYmFja3NsYXNoIHRoZW4gcXVvdGF0aW9uTWFyaysrXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBjID09ICdcIicgYW5kICFiYWNrc2xhc2ggdGhlbiBkb3VibGVRdW90YXRpb25NYXJrKytcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhY2tzbGFzaCA9IGlmIGMgPT0gXCJcXFxcXCIgYW5kICFiYWNrc2xhc2ggdGhlbiB0cnVlIGVsc2UgZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYXJGb3VuZCA9IGlmIGMgIT0gXCIgXCIgYW5kICFjaGFyRm91bmQgdGhlbiB0cnVlIGVsc2UgY2hhckZvdW5kXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBjID09IFwiIFwiIGFuZCBxdW90YXRpb25NYXJrICUgMiA9PSAwIGFuZCBkb3VibGVRdW90YXRpb25NYXJrICUgMiA9PSAwIGFuZCBjaGFyRm91bmRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBibGFua1BvcyA9IGlkeFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWR4ID0gYmxhbmtQb3NcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQgPSBpZiBAbW9kZSA9PSBcImJyZWFrXCIgdGhlbiAxIGVsc2UgbGVuXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBpZHggaXNudCAtMVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGxpdFN0cmluZyAgPSBbbGluZS5zdWJzdHJpbmcoMCxpZHgpLCBsaW5lLnN1YnN0cmluZyhpZHgrbmV4dCldXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8uc3BsaXRlZCA9IHNwbGl0U3RyaW5nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGwgPSBAX19jb21wdXRlTGVuZ3RoKHNwbGl0U3RyaW5nWzBdKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBtYXggPD0gbFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4ID0gbFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4KysgaWYgbCA+IDAgJiYgYWRkU3BhY2VQcmVmaXggJiYgc3BsaXRTdHJpbmdbMF0uY2hhckF0KHNwbGl0U3RyaW5nWzBdLmxlbmd0aC0xKSAhPSBcIiBcIlxuXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IGZhbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICBfLmZvckVhY2ggQGFsaWdubWVudHMsIChuZXh0UG9zc2libGVNYXRjaGVyKSAtPlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsaW5lLmluZGV4T2YobmV4dFBvc3NpYmxlTWF0Y2hlciwgaWR4K2xlbikgIT0gLTEpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kID0gdHJ1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2VcblxuICAgICAgICAgICAgICAgICAgICAgICAgby5zdG9wID0gIWZvdW5kXG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXG5cbiAgICAgICAgICAgICAgICBpZiAobWF4ID49IDApXG4gICAgICAgICAgICAgICAgICAgIG1heCsrIGlmIG1heCA+IDBcblxuICAgICAgICAgICAgICAgICAgICBAcm93cy5mb3JFYWNoIChvKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgIW8uZG9uZSBhbmQgby5zcGxpdGVkIGFuZCBtYXRjaGVkXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BsaXRTdHJpbmcgPSBvLnNwbGl0ZWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWZmID0gbWF4IC0gQF9fY29tcHV0ZUxlbmd0aChzcGxpdFN0cmluZ1swXSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBkaWZmID4gMFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGxpdFN0cmluZ1swXSA9IHNwbGl0U3RyaW5nWzBdICsgQXJyYXkoZGlmZikuam9pbignICcpXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGxpdFN0cmluZ1sxXSA9IFwiIFwiK3NwbGl0U3RyaW5nWzFdLnRyaW0oKSBpZiBAYWRkU3BhY2VQb3N0Zml4ICYmIGFkZFNwYWNlUHJlZml4XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBAbW9kZSA9PSBcImJyZWFrXCJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5mb3JFYWNoIHNwbGl0U3RyaW5nLCAocywgaSkgLT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwbGl0U3RyaW5nW2ldID0gcy50cmltKClcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvLnRleHQgPSBzcGxpdFN0cmluZy5qb2luKFwiXFxuXCIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvLnRleHQgPSBzcGxpdFN0cmluZy5qb2luKG1hdGNoZWQpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgby5kb25lID0gby5zdG9wXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgby5uZXh0UG9zID0gc3BsaXRTdHJpbmdbMF0ubGVuZ3RoK21hdGNoZWQubGVuZ3RoXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgICAgICByZXR1cm4gQGFsaWdubWVudHMubGVuZ3RoID4gMFxuICAgICAgICAgICAgZWxzZSAjY3Vyc29yXG4gICAgICAgICAgICAgICAgQHJvd3MuZm9yRWFjaCAobykgLT5cbiAgICAgICAgICAgICAgICAgICAgaWYgbWF4IDw9IG8uY29sdW1uXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXggPSBvLmNvbHVtblxuICAgICAgICAgICAgICAgICAgICAgICAgcGFydCA9IG8udGV4dC5zdWJzdHJpbmcoMCxvLnZpcnR1YWxDb2x1bW4pXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXgrKyBpZiBwYXJ0Lmxlbmd0aCA+IDAgJiYgby5hZGRTcGFjZVByZWZpeCAmJiBwYXJ0LmNoYXJBdChwYXJ0Lmxlbmd0aC0xKSAhPSBcIiBcIlxuICAgICAgICAgICAgICAgICAgICByZXR1cm5cblxuICAgICAgICAgICAgICAgIG1heCsrXG5cbiAgICAgICAgICAgICAgICBAcm93cy5mb3JFYWNoIChvKSA9PlxuICAgICAgICAgICAgICAgICAgICBsaW5lID0gby50ZXh0XG4gICAgICAgICAgICAgICAgICAgIHNwbGl0U3RyaW5nID0gW2xpbmUuc3Vic3RyaW5nKDAsby52aXJ0dWFsQ29sdW1uKSwgbGluZS5zdWJzdHJpbmcoby52aXJ0dWFsQ29sdW1uKV1cbiAgICAgICAgICAgICAgICAgICAgZGlmZiA9IG1heCAtIEBfX2NvbXB1dGVMZW5ndGgoc3BsaXRTdHJpbmdbMF0pXG4gICAgICAgICAgICAgICAgICAgIGlmIGRpZmYgPiAwXG4gICAgICAgICAgICAgICAgICAgICAgICBzcGxpdFN0cmluZ1swXSA9IHNwbGl0U3RyaW5nWzBdICsgQXJyYXkoZGlmZikuam9pbignICcpXG5cbiAgICAgICAgICAgICAgICAgICAgby5zcGFjZUNoYXJMZW5ndGggPz0gMFxuICAgICAgICAgICAgICAgICAgICBzcGxpdFN0cmluZ1sxXSA9IHNwbGl0U3RyaW5nWzFdLnN1YnN0cmluZygwLCBvLnNwYWNlQ2hhckxlbmd0aCkgKyBzcGxpdFN0cmluZ1sxXS5zdWJzdHIoby5zcGFjZUNoYXJMZW5ndGgpLnRyaW0oKVxuICAgICAgICAgICAgICAgICAgICBpZiBAYWRkU3BhY2VQb3N0Zml4ICYmIG8uYWRkU3BhY2VQcmVmaXhcbiAgICAgICAgICAgICAgICAgICAgICAgIHNwbGl0U3RyaW5nWzFdID0gc3BsaXRTdHJpbmdbMV0uc3Vic3RyaW5nKDAsIG8uc3BhY2VDaGFyTGVuZ3RoKSArIFwiIFwiICtzcGxpdFN0cmluZ1sxXS5zdWJzdHIoby5zcGFjZUNoYXJMZW5ndGgpXG5cbiAgICAgICAgICAgICAgICAgICAgby50ZXh0ID0gc3BsaXRTdHJpbmcuam9pbihcIlwiKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2VcblxuICAgICAgICAjIFB1YmxpY1xuICAgICAgICBhbGlnbjogKG11bHRpcGxlKSA9PlxuICAgICAgICAgICAgQF9fZ2V0Um93cygpXG4gICAgICAgICAgICBAX19nZW5lcmF0ZUFsaWdubWVudExpc3QoKVxuICAgICAgICAgICAgaWYgQHJvd3MubGVuZ3RoID09IDEgJiYgbXVsdGlwbGVcbiAgICAgICAgICAgICAgICBAbW9kZSA9IFwiYnJlYWtcIlxuXG4gICAgICAgICAgICBpZiBtdWx0aXBsZSB8fCBAbW9kZSA9PSBcImJyZWFrXCJcbiAgICAgICAgICAgICAgICBsb29wXG4gICAgICAgICAgICAgICAgICAgIGNvbnQgPSBAX19jb21wdXRlUm93cygpXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrIGlmIG5vdCBjb250XG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgQF9fY29tcHV0ZVJvd3MoKVxuXG4gICAgICAgICAgICBjaGVja3BvaW50ID0gQGVkaXRvci5jcmVhdGVDaGVja3BvaW50KClcbiAgICAgICAgICAgIEByb3dzLmZvckVhY2ggKG8pID0+XG4gICAgICAgICAgICAgICAgQGVkaXRvci5zZXRUZXh0SW5CdWZmZXJSYW5nZShbW28ucm93LCAwXSxbby5yb3csIG8ubGVuZ3RoXV0sIG8udGV4dClcbiAgICAgICAgICAgICAgICBpZiBvLmN1cnNvclxuICAgICAgICAgICAgICAgICAgICBvLmN1cnNvci5zZXRCdWZmZXJQb3NpdGlvbihbby5yb3csIG8udmlydHVhbENvbHVtbiArIChvLnRleHQubGVuZ3RoIC0gby5sZW5ndGgpXSlcbiAgICAgICAgICAgIEBlZGl0b3IuZ3JvdXBDaGFuZ2VzU2luY2VDaGVja3BvaW50KGNoZWNrcG9pbnQpXG4iXX0=
