'use babel';

Object.defineProperty(exports, '__esModule', {
  value: true
});
var atom = global.atom;
var crypto = require('crypto');

var decrypt = function decrypt(password, text) {
  try {
    var decipher = crypto.createDecipher('aes-256-ctr', password);
    var dec = decipher.update(text, 'hex', 'utf8');
    return dec;
  } catch (e) {
    return null;
  }
};

exports.decrypt = decrypt;
var encrypt = function encrypt(password, text) {
  try {
    var cipher = crypto.createCipher('aes-256-ctr', password);
    var crypted = cipher.update(text, 'utf8', 'hex');
    crypted += cipher.final('hex');
    return crypted;
  } catch (e) {
    return null;
  }
};

exports.encrypt = encrypt;
var checkPasswordExists = function checkPasswordExists() {
  var passwordHash = atom.config.get('ftp-remote-edit.password');

  // migrate from ftp-remote-edit-plus
  if (!passwordHash) {
    passwordHash = atom.config.get('ftp-remote-edit-plus.password');
    if (passwordHash) {
      var servers = atom.config.get('ftp-remote-edit-plus.servers');
      atom.config.set('ftp-remote-edit.config', servers);
      atom.config.set('ftp-remote-edit.password', passwordHash);
    }
  }
  if (passwordHash) return true;

  return false;
};

exports.checkPasswordExists = checkPasswordExists;
var checkPassword = function checkPassword(password) {
  var passwordHash = atom.config.get('ftp-remote-edit.password');
  if (!passwordHash) return true;

  if (decrypt(password, passwordHash) !== password) {
    return false;
  }

  return true;
};

exports.checkPassword = checkPassword;
var setPassword = function setPassword(password) {
  var promise = new Promise(function (resolve, reject) {
    var passwordHash = encrypt(password, password);

    // Store in atom config
    atom.config.set('ftp-remote-edit.password', passwordHash);

    resolve(true);
  });

  return promise;
};

exports.setPassword = setPassword;
var changePassword = function changePassword(oldPassword, newPassword) {
  var promise = new Promise(function (resolve, reject) {
    var passwordHash = encrypt(newPassword, newPassword);

    // Store in atom config
    atom.config.set('ftp-remote-edit.password', passwordHash);

    var configHash = atom.config.get('ftp-remote-edit.config');
    if (configHash) {
      var oldconfig = decrypt(oldPassword, configHash);
      var newconfig = encrypt(newPassword, oldconfig);

      var oldWhitelist = getHashList(oldPassword, 'ftp-remote-edit.allowedConsumers');
      var oldBlacklist = getHashList(oldPassword, 'ftp-remote-edit.disallowedConsumers');

      // Store in atom config
      atom.config.set('ftp-remote-edit.config', newconfig);
      setHashList(newPassword, 'ftp-remote-edit.allowedConsumers', oldWhitelist);
      setHashList(newPassword, 'ftp-remote-edit.disallowedConsumers', oldBlacklist);
    }

    resolve(true);
  });

  return promise;
};

exports.changePassword = changePassword;
var isInWhiteList = function isInWhiteList(password, msg) {
  var hashes = getHashList(password, 'ftp-remote-edit.allowedConsumers');
  return hashes.indexOf(msg) > -1;
};

exports.isInWhiteList = isInWhiteList;
var isInBlackList = function isInBlackList(password, msg) {
  var hashes = getHashList(password, 'ftp-remote-edit.disallowedConsumers');
  return hashes.indexOf(msg) > -1;
};

exports.isInBlackList = isInBlackList;
var addToWhiteList = function addToWhiteList(password, msg) {
  addToHashList(password, 'ftp-remote-edit.allowedConsumers', msg);
};

exports.addToWhiteList = addToWhiteList;
var addToBlackList = function addToBlackList(password, msg) {
  addToHashList(password, 'ftp-remote-edit.disallowedConsumers', msg);
};

exports.addToBlackList = addToBlackList;
var getHashList = function getHashList(password, setting) {
  var conf = atom.config.get(setting);
  if (conf) {
    try {
      return JSON.parse(decrypt(password, conf));
    } catch (ex) {
      return [];
    }
  } else {
    return [];
  }
};

var setHashList = function setHashList(password, setting, hashes) {
  try {
    var str = JSON.stringify(hashes);
    atom.config.set(setting, encrypt(password, str));
  } catch (ex) {
    return [];
  }
};

var addToHashList = function addToHashList(password, setting, msg) {
  var hashes = getHashList(password, setting);
  hashes.push(msg);
  var str = JSON.stringify(hashes);
  atom.config.set(setting, encrypt(password, str));
};

var b64EncodeUnicode = function b64EncodeUnicode(str) {
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function (match, p1) {
    return String.fromCharCode('0x' + p1);
  }));
};

exports.b64EncodeUnicode = b64EncodeUnicode;
var b64DecodeUnicode = function b64DecodeUnicode(str) {
  return decodeURIComponent(atob(str).split('').map(function (c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
};
exports.b64DecodeUnicode = b64DecodeUnicode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zdWRwcmF3YXQvLmF0b20vcGFja2FnZXMvZnRwLXJlbW90ZS1lZGl0L2xpYi9oZWxwZXIvc2VjdXJlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7QUFFWixJQUFNLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDO0FBQ3pCLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQzs7QUFFMUIsSUFBTSxPQUFPLEdBQUcsU0FBVixPQUFPLENBQUksUUFBUSxFQUFFLElBQUksRUFBSztBQUN6QyxNQUFJO0FBQ0YsUUFBSSxRQUFRLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFDOUQsUUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQy9DLFdBQU8sR0FBRyxDQUFDO0dBQ1osQ0FBQyxPQUFPLENBQUMsRUFBRTtBQUNWLFdBQU8sSUFBSSxDQUFDO0dBQ2I7Q0FDRixDQUFBOzs7QUFFTSxJQUFNLE9BQU8sR0FBRyxTQUFWLE9BQU8sQ0FBSSxRQUFRLEVBQUUsSUFBSSxFQUFLO0FBQ3pDLE1BQUk7QUFDRixRQUFJLE1BQU0sR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLGFBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQztBQUMxRCxRQUFJLE9BQU8sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDakQsV0FBTyxJQUFJLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDL0IsV0FBTyxPQUFPLENBQUM7R0FDaEIsQ0FBQyxPQUFPLENBQUMsRUFBRTtBQUNWLFdBQU8sSUFBSSxDQUFDO0dBQ2I7Q0FDRixDQUFBOzs7QUFFTSxJQUFNLG1CQUFtQixHQUFHLFNBQXRCLG1CQUFtQixHQUFTO0FB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QUM7Q0FDTCxDQUFBOzs7QUFFTSxJQUFNLGdCQUFnQixHQUFHLFNBQW5CLGdCQUFnQixDQUFJLEdBQUcsRUFBSztBQUN2QyxTQUFPLGtCQUFrQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQUMsQ0FBQyxFQUFLO0FBQ3ZELFdBQU8sR0FBRyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFBLENBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7R0FDOUQsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0NBQ2QsQ0FBQSIsImZpbGUiOiIvVXNlcnMvc3VkcHJhd2F0Ly5hdG9tL3BhY2thZ2VzL2Z0cC1yZW1vdGUtZWRpdC9saWIvaGVscGVyL3NlY3VyZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuXG5jb25zdCBhdG9tID0gZ2xvYmFsLmF0b207XG5jb25zdCBjcnlwdG8gPSByZXF1aXJlKCdjcnlwdG8nKTtcblxuZXhwb3J0IGNvbnN0IGRlY3J5cHQgPSAocGFzc3dvcmQsIHRleHQpID0+IHtcbiAgdHJ5IHtcbiAgICBsZXQgZGVjaXBoZXIgPSBjcnlwdG8uY3JlYXRlRGVjaXBoZXIoJ2Flcy0yNTYtY3RyJywgcGFzc3dvcmQpO1xuICAgIGxldCBkZWMgPSBkZWNpcGhlci51cGRhdGUodGV4dCwgJ2hleCcsICd1dGY4Jyk7XG4gICAgcmV0dXJuIGRlYztcbiAgfSBjYXRjaCAoZSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBlbmNyeXB0ID0gKHBhc3N3b3JkLCB0ZXh0KSA9PiB7XG4gIHRyeSB7XG4gICAgbGV0IGNpcGhlciA9IGNyeXB0by5jcmVhdGVDaXBoZXIoJ2Flcy0yNTYtY3RyJywgcGFzc3dvcmQpO1xuICAgIGxldCBjcnlwdGVkID0gY2lwaGVyLnVwZGF0ZSh0ZXh0LCAndXRmOCcsICdoZXgnKTtcbiAgICBjcnlwdGVkICs9IGNpcGhlci5maW5hbCgnaGV4Jyk7XG4gICAgcmV0dXJuIGNyeXB0ZWQ7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgY2hlY2tQYXNzd29yZEV4aXN0cyA9ICgpID0+IHtcbiAgbGV0IHBhc3N3b3JkSGFzaCA9IGF0b20uY29uZmlnLmdldCgnZnRwLXJlbW90ZS1lZGl0LnBhc3N3b3JkJyk7XG5cbiAgLy8gbWlncmF0ZSBmcm9tIGZ0cC1yZW1vdGUtZWRpdC1wbHVzXG4gIGlmKCFwYXNzd29yZEhhc2gpe1xuICAgIHBhc3N3b3JkSGFzaCA9IGF0b20uY29uZmlnLmdldCgnZnRwLXJlbW90ZS1lZGl0LXBsdXMucGFzc3dvcmQnKTtcbiAgICBpZiAocGFzc3dvcmRIYXNoKSB7XG4gICAgICBsZXQgc2VydmVycyA9IGF0b20uY29uZmlnLmdldCgnZnRwLXJlbW90ZS1lZGl0LXBsdXMuc2VydmVycycpO1xuICAgICAgYXRvbS5jb25maWcuc2V0KCdmdHAtcmVtb3RlLWVkaXQuY29uZmlnJywgc2VydmVycyk7XG4gICAgICBhdG9tLmNvbmZpZy5zZXQoJ2Z0cC1yZW1vdGUtZWRpdC5wYXNzd29yZCcsIHBhc3N3b3JkSGFzaCk7XG4gICAgfVxuICB9XG4gIGlmIChwYXNzd29yZEhhc2gpIHJldHVybiB0cnVlO1xuXG4gIHJldHVybiBmYWxzZTtcbn1cblxuZXhwb3J0IGNvbnN0IGNoZWNrUGFzc3dvcmQgPSAocGFzc3dvcmQpID0+IHtcbiAgbGV0IHBhc3N3b3JkSGFzaCA9IGF0b20uY29uZmlnLmdldCgnZnRwLXJlbW90ZS1lZGl0LnBhc3N3b3JkJyk7XG4gIGlmICghcGFzc3dvcmRIYXNoKSByZXR1cm4gdHJ1ZTtcblxuICBpZiAoZGVjcnlwdChwYXNzd29yZCwgcGFzc3dvcmRIYXNoKSAhPT0gcGFzc3dvcmQpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICByZXR1cm4gdHJ1ZTtcbn1cblxuZXhwb3J0IGNvbnN0IHNldFBhc3N3b3JkID0gKHBhc3N3b3JkKSA9PiB7XG4gIGxldCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGxldCBwYXNzd29yZEhhc2ggPSBlbmNyeXB0KHBhc3N3b3JkLCBwYXNzd29yZCk7XG5cbiAgICAvLyBTdG9yZSBpbiBhdG9tIGNvbmZpZ1xuICAgIGF0b20uY29uZmlnLnNldCgnZnRwLXJlbW90ZS1lZGl0LnBhc3N3b3JkJywgcGFzc3dvcmRIYXNoKTtcblxuICAgIHJlc29sdmUodHJ1ZSk7XG4gIH0pO1xuXG4gIHJldHVybiBwcm9taXNlO1xufVxuXG5leHBvcnQgY29uc3QgY2hhbmdlUGFzc3dvcmQgPSAob2xkUGFzc3dvcmQsIG5ld1Bhc3N3b3JkKSA9PiB7XG4gIGxldCBwcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGxldCBwYXNzd29yZEhhc2ggPSBlbmNyeXB0KG5ld1Bhc3N3b3JkLCBuZXdQYXNzd29yZCk7XG5cbiAgICAvLyBTdG9yZSBpbiBhdG9tIGNvbmZpZ1xuICAgIGF0b20uY29uZmlnLnNldCgnZnRwLXJlbW90ZS1lZGl0LnBhc3N3b3JkJywgcGFzc3dvcmRIYXNoKTtcblxuICAgIGxldCBjb25maWdIYXNoID0gYXRvbS5jb25maWcuZ2V0KCdmdHAtcmVtb3RlLWVkaXQuY29uZmlnJyk7XG4gICAgaWYgKGNvbmZpZ0hhc2gpIHtcbiAgICAgIGxldCBvbGRjb25maWcgPSBkZWNyeXB0KG9sZFBhc3N3b3JkLCBjb25maWdIYXNoKTtcbiAgICAgIGxldCBuZXdjb25maWcgPSBlbmNyeXB0KG5ld1Bhc3N3b3JkLCBvbGRjb25maWcpO1xuXG4gICAgICBsZXQgb2xkV2hpdGVsaXN0ID0gZ2V0SGFzaExpc3Qob2xkUGFzc3dvcmQsICdmdHAtcmVtb3RlLWVkaXQuYWxsb3dlZENvbnN1bWVycycpO1xuICAgICAgbGV0IG9sZEJsYWNrbGlzdCA9IGdldEhhc2hMaXN0KG9sZFBhc3N3b3JkLCAnZnRwLXJlbW90ZS1lZGl0LmRpc2FsbG93ZWRDb25zdW1lcnMnKTtcblxuICAgICAgLy8gU3RvcmUgaW4gYXRvbSBjb25maWdcbiAgICAgIGF0b20uY29uZmlnLnNldCgnZnRwLXJlbW90ZS1lZGl0LmNvbmZpZycsIG5ld2NvbmZpZyk7XG4gICAgICBzZXRIYXNoTGlzdChuZXdQYXNzd29yZCwgJ2Z0cC1yZW1vdGUtZWRpdC5hbGxvd2VkQ29uc3VtZXJzJywgb2xkV2hpdGVsaXN0KTtcbiAgICAgIHNldEhhc2hMaXN0KG5ld1Bhc3N3b3JkLCAnZnRwLXJlbW90ZS1lZGl0LmRpc2FsbG93ZWRDb25zdW1lcnMnLCBvbGRCbGFja2xpc3QpO1xuICAgIH1cblxuICAgIHJlc29sdmUodHJ1ZSk7XG4gIH0pO1xuXG4gIHJldHVybiBwcm9taXNlO1xufVxuXG5leHBvcnQgY29uc3QgaXNJbldoaXRlTGlzdCA9IChwYXNzd29yZCwgbXNnKSA9PiB7XG4gIGxldCBoYXNoZXMgPSBnZXRIYXNoTGlzdChwYXNzd29yZCwgJ2Z0cC1yZW1vdGUtZWRpdC5hbGxvd2VkQ29uc3VtZXJzJyk7XG4gIHJldHVybiBoYXNoZXMuaW5kZXhPZihtc2cpID4gLTFcbn1cblxuZXhwb3J0IGNvbnN0IGlzSW5CbGFja0xpc3QgPSAocGFzc3dvcmQsIG1zZykgPT4ge1xuICBsZXQgaGFzaGVzID0gZ2V0SGFzaExpc3QocGFzc3dvcmQsICdmdHAtcmVtb3RlLWVkaXQuZGlzYWxsb3dlZENvbnN1bWVycycpO1xuICByZXR1cm4gaGFzaGVzLmluZGV4T2YobXNnKSA+IC0xXG59XG5cbmV4cG9ydCBjb25zdCBhZGRUb1doaXRlTGlzdCA9IChwYXNzd29yZCwgbXNnKSA9PiB7XG4gIGFkZFRvSGFzaExpc3QocGFzc3dvcmQsICdmdHAtcmVtb3RlLWVkaXQuYWxsb3dlZENvbnN1bWVycycsIG1zZyk7XG59XG5cbmV4cG9ydCBjb25zdCBhZGRUb0JsYWNrTGlzdCA9IChwYXNzd29yZCwgbXNnKSA9PiB7XG4gIGFkZFRvSGFzaExpc3QocGFzc3dvcmQsICdmdHAtcmVtb3RlLWVkaXQuZGlzYWxsb3dlZENvbnN1bWVycycsIG1zZyk7XG59XG5cbmNvbnN0IGdldEhhc2hMaXN0ID0gKHBhc3N3b3JkLCBzZXR0aW5nKSA9PiB7XG4gIGxldCBjb25mID0gYXRvbS5jb25maWcuZ2V0KHNldHRpbmcpO1xuICBpZiAoY29uZikge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShkZWNyeXB0KHBhc3N3b3JkLCBjb25mKSk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHJldHVybiBbXVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gW11cbiAgfVxufVxuXG5jb25zdCBzZXRIYXNoTGlzdCA9IChwYXNzd29yZCwgc2V0dGluZywgaGFzaGVzKSA9PiB7XG4gIHRyeSB7XG4gICAgbGV0IHN0ciA9IEpTT04uc3RyaW5naWZ5KGhhc2hlcyk7XG4gICAgYXRvbS5jb25maWcuc2V0KHNldHRpbmcsIGVuY3J5cHQocGFzc3dvcmQsIHN0cikpO1xuICB9IGNhdGNoIChleCkge1xuICAgIHJldHVybiBbXVxuICB9XG59XG5cbmNvbnN0IGFkZFRvSGFzaExpc3QgPSAocGFzc3dvcmQsIHNldHRpbmcsIG1zZykgPT4ge1xuICBsZXQgaGFzaGVzID0gZ2V0SGFzaExpc3QocGFzc3dvcmQsIHNldHRpbmcpO1xuICBoYXNoZXMucHVzaChtc2cpO1xuICBsZXQgc3RyID0gSlNPTi5zdHJpbmdpZnkoaGFzaGVzKTtcbiAgYXRvbS5jb25maWcuc2V0KHNldHRpbmcsIGVuY3J5cHQocGFzc3dvcmQsIHN0cikpO1xufVxuXG5leHBvcnQgY29uc3QgYjY0RW5jb2RlVW5pY29kZSA9IChzdHIpID0+IHtcbiAgcmV0dXJuIGJ0b2EoZW5jb2RlVVJJQ29tcG9uZW50KHN0cikucmVwbGFjZSgvJShbMC05QS1GXXsyfSkvZywgKG1hdGNoLCBwMSkgPT4ge1xuICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKCcweCcgKyBwMSk7XG4gIH0pKTtcbn1cblxuZXhwb3J0IGNvbnN0IGI2NERlY29kZVVuaWNvZGUgPSAoc3RyKSA9PiB7XG4gIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQoYXRvYihzdHIpLnNwbGl0KCcnKS5tYXAoKGMpID0+IHtcbiAgICByZXR1cm4gJyUnICsgKCcwMCcgKyBjLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpKS5zbGljZSgtMik7XG4gIH0pLmpvaW4oJycpKTtcbn1cbiJdfQ==