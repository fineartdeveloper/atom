Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.provideStructure = provideStructure;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _lodashTrim = require('lodash/trim');

var _lodashTrim2 = _interopRequireDefault(_lodashTrim);

var _utils = require('./utils');

var _tokenizer = require('./tokenizer');

'use babel';

var STRING = _tokenizer.TokenType.STRING;
var NULL = _tokenizer.TokenType.NULL;
var SYMBOL = _tokenizer.TokenType.SYMBOL;
var NUMBER = _tokenizer.TokenType.NUMBER;
var BEGIN_OBJECT = _tokenizer.TokenType.BEGIN_OBJECT;
var END_OBJECT = _tokenizer.TokenType.END_OBJECT;
var BEGIN_ARRAY = _tokenizer.TokenType.BEGIN_ARRAY;
var END_ARRAY = _tokenizer.TokenType.END_ARRAY;
var END_LABEL = _tokenizer.TokenType.END_LABEL;
var COMMA = _tokenizer.TokenType.COMMA;

function intersectsWithToken(position, token) {
  var tRow = token.line - 1;
  var pRow = position.row;
  var tCol = token.col;
  var tLength = token.src.length;
  var pCol = position.column;

  if (token.type === STRING) {
    return tRow === pRow && tCol <= pCol && tCol + tLength - 1 > pCol; // attention to ""
  }
  return tRow === pRow && tCol <= pCol && tCol + tLength > pCol;
}

function isBetweenTokenType(position, firstToken, secondToken) {
  var pRow = position.row;
  var pCol = position.column;
  var fRow = firstToken.line - 1;
  var sRow = secondToken.line - 1;
  var fEnd = firstToken.col + firstToken.src.length - 1;
  var sStart = secondToken.col;

  // cursor position and the 2 tokens are on the same line
  if (pRow === fRow && pRow === sRow) {
    return pCol >= fEnd && pCol < sStart;
  }
  // cursor position is not on the same line as the 2 other tokens but is between them
  return pRow > fRow && pRow < sRow || // firstToken \n+ position \n+ secondToken
  pRow === fRow && pRow < sRow && pCol >= fEnd // fistToken position \n+ secondToken
   || pRow > fRow && pRow === sRow && pCol < sStart; // firstToken \n+ position secondToken
}

function consumeValue(tokens, container, position, posInfo, posInfoHolder) {
  var valueStartToken = tokens.next();

  function checkPosition() {
    if (!posInfoHolder.hasValue() && intersectsWithToken(position, valueStartToken)) {
      var info = posInfo.setValuePosition().setEditedToken(valueStartToken).setPreviousToken(tokens.peekPrevious()).setNextToken(tokens.peekNext()).toObject();
      posInfoHolder.set(info);
    }
  }

  switch (valueStartToken.type) {
    case STRING:
      container.push((0, _lodashTrim2['default'])(valueStartToken.src, '"'));
      checkPosition();
      break;
    case NULL:
      container.push(null);
      checkPosition();
      break;
    case SYMBOL:
      container.push(undefined);
      checkPosition();
      break;
    case NUMBER:
      container.push(Number(valueStartToken.src));
      checkPosition();
      break;
    case BEGIN_OBJECT:
      var object = {};
      consumeObject(object, tokens, position, posInfo, posInfoHolder);
      container.push(object);
      break;
    case BEGIN_ARRAY:
      var array = [];
      consumeArray(array, tokens, position, posInfo, posInfoHolder);
      container.push(array);
      break;
    default:
      break;
  }
  return posInfo;
}

function consumeKeyValuePair(object, tokens, position, posInfo, posInfoHolder) {
  if (tokens.hasNext() && tokens.peekNext().type === END_OBJECT) {
    if (!posInfoHolder.hasValue() && isBetweenTokenType(position, tokens.current(), tokens.peekNext())) {
      var info = posInfo.setKeyPosition().setPreviousToken(tokens.current()).setNextToken(tokens.peekNext()).toObject();
      posInfoHolder.set(info);
    }
    return;
  }

  if (!posInfoHolder.hasValue() && isBetweenTokenType(position, tokens.current(), tokens.peekNext())) {
    var info = posInfo.setKeyPosition().setPreviousToken(tokens.current()).setNextToken(tokens.peekNext()).toObject();
    posInfoHolder.set(info);
  }

  var keyToken = tokens.next();
  // First token is not a key, skip it.
  if (keyToken.type !== STRING && keyToken.type !== SYMBOL) {
    return;
  }

  if (!posInfoHolder.hasValue() && intersectsWithToken(position, keyToken)) {
    var info = posInfo.setKeyPosition().setPreviousToken(tokens.peekPrevious()).setEditedToken(keyToken).setNextToken(tokens.peekNext()).toObject();
    posInfoHolder.set(info);
  }

  var key = (0, _lodashTrim2['default'])(keyToken.src, '"');
  var separatorToken = tokens.next();
  if (separatorToken.type === END_LABEL) {
    var pathWithKey = posInfo.add(key);
    if (!posInfoHolder.hasValue() && isBetweenTokenType(position, separatorToken, tokens.peekNext())) {
      var info = pathWithKey.setValuePosition().setPreviousToken(separatorToken).setNextToken(tokens.peekNext()).toObject();
      posInfoHolder.set(info);
    }
    // Complete key-value pair
    var valContainer = [];
    consumeValue(tokens, valContainer, position, pathWithKey, posInfoHolder);
    var value = valContainer[0];

    object[key] = value;
  } else {
    // separator in place, value probably under editing
    object[key] = undefined;
  }
}

function consumeObject(object, tokens, position, posInfo, posInfoHolder) {
  while (tokens.hasNext()) {
    consumeKeyValuePair(object, tokens, position, posInfo, posInfoHolder);
    if (tokens.hasNext()) {
      var token = tokens.next();
      switch (token.type) {
        case END_OBJECT:
          return; // end of object
        case COMMA:
          break; // ',' read - nothing else to do
        default:
          tokens.previous(); // something else, go back
      }
    }
  }
}

function consumeArray(array, tokens, position, posInfo, posInfoHolder) {
  var index = 0;
  while (tokens.hasNext()) {
    if (tokens.hasNext()) {
      var token = tokens.next();
      if (!posInfoHolder.hasValue() && isBetweenTokenType(position, tokens.peekPrevious(), token)) {
        var info = posInfo.add(index).setValuePosition().setPreviousToken(tokens.peekPrevious()).setNextToken(token).toObject();
        posInfoHolder.set(info);
      }
      switch (token.type) {
        case END_ARRAY:
          return; // end of array
        default:
          tokens.previous(); // something else, go back
      }
    }

    var valContainer = [];
    consumeValue(tokens, valContainer, position, posInfo.add(index), posInfoHolder);
    var value = valContainer[0];

    array.push(value);
    index++;

    if (tokens.hasNext()) {
      var token = tokens.next();
      if (!posInfoHolder.hasValue() && isBetweenTokenType(position, token, tokens.peekNext())) {
        var info = posInfo.add(index).setValuePosition().setPreviousToken(token).setNextToken(tokens.peekNext()).toObject();
        posInfoHolder.set(info);
      }
      switch (token.type) {
        case END_ARRAY:
          return; // end of object
        case COMMA:
          break; // ',' read - nothing else to do
        default:
          tokens.previous(); // something else, go back
      }
    }
  }
}

function provideStructure(tokensArray, position) {
  var tokens = new _utils.ArrayTraverser(tokensArray);

  if (!tokens.hasNext()) {
    return { contents: null, positionInfo: null, tokens: tokensArray }; // no tokens
  }

  var posInfoHolder = new _utils.ValueHolder();
  var firstToken = tokens.next();
  if (firstToken.type === BEGIN_OBJECT) {
    var object = {};
    consumeObject(object, tokens, position, new _utils.PositionInfo(), posInfoHolder);
    return { contents: object, positionInfo: posInfoHolder.getOrElse(null), tokens: tokensArray };
  } else if (firstToken.type === BEGIN_ARRAY) {
    var array = [];
    consumeArray(array, tokens, position, new _utils.PositionInfo(), posInfoHolder);
    return { contents: array, positionInfo: posInfoHolder.getOrElse(null), tokens: tokensArray };
  }
  return { contents: null, positionInfo: null, tokens: tokensArray }; // don't bother with strings, numbers, etc. for now
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zdWRwcmF3YXQvLmF0b20vcGFja2FnZXMvYXV0b2NvbXBsZXRlLWpzb24vc3JjL3N0cnVjdHVyZS1wcm92aWRlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7OzBCQUVpQixhQUFhOzs7O3FCQUM0QixTQUFTOzt5QkFDekMsYUFBYTs7QUFKdkMsV0FBVyxDQUFBOztJQU1ILE1BQU0sd0JBQU4sTUFBTTtJQUFFLElBQUksd0JBQUosSUFBSTtJQUFFLE1BQU0sd0JBQU4sTUFBTTtJQUFFLE1BQU0sd0JBQU4sTUFBTTtJQUFFLFlBQVksd0JBQVosWUFBWTtJQUFFLFVBQVUsd0JBQVYsVUFBVTtJQUFFLFdBQVcsd0JBQVgsV0FBVztJQUFFLFNBQVMsd0JBQVQsU0FBUztJQUFFLFNBQVMsd0JBQVQsU0FBUztJQUFFLEtBQUssd0JBQUwsS0FBSzs7QUFFeEcsU0FBUyxtQkFBbUIsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFO0FBQzVDLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFBO0FBQzNCLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUE7QUFDekIsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQTtBQUN0QixNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQTtBQUNoQyxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFBOztBQUU1QixNQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssTUFBTSxFQUFFO0FBQ3pCLFdBQU8sSUFBSSxLQUFLLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksR0FBRyxPQUFPLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQTtHQUNsRTtBQUNELFNBQU8sSUFBSSxLQUFLLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksR0FBRyxPQUFPLEdBQUcsSUFBSSxDQUFBO0NBRTlEOztBQUVELFNBQVMsa0JBQWtCLENBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUU7QUFDN0QsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQTtBQUN6QixNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFBO0FBQzVCLE1BQU0sSUFBSSxHQUFHLFVBQVUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFBO0FBQ2hDLE1BQU0sSUFBSSxHQUFHLFdBQVcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFBO0FBQ2pDLE1BQU0sSUFBSSxHQUFHLFVBQVUsQ0FBQyxHQUFHLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO0FBQ3ZELE1BQU0sTUFBTSxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUE7OztBQUc5QixNQUFJLElBQUksS0FBSyxJQUFJLElBQUksSUFBSSxLQUFLLElBQUksRUFBRTtBQUNsQyxXQUFPLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxHQUFHLE1BQU0sQ0FBQTtHQUNyQzs7QUFFRCxTQUFPLEFBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxJQUFJLEdBQUcsSUFBSTtBQUM1QixNQUFJLEtBQUssSUFBSSxJQUFJLElBQUksR0FBRyxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksQUFBQztNQUM3QyxJQUFJLEdBQUcsSUFBSSxJQUFJLElBQUksS0FBSyxJQUFJLElBQUksSUFBSSxHQUFHLE1BQU0sQUFBQyxDQUFBO0NBQ3JEOztBQUVELFNBQVMsWUFBWSxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUU7QUFDekUsTUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFBOztBQUVyQyxXQUFTLGFBQWEsR0FBRztBQUN2QixRQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxJQUFJLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxlQUFlLENBQUMsRUFBRTtBQUMvRSxVQUFNLElBQUksR0FBRyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsQ0FDcEMsY0FBYyxDQUFDLGVBQWUsQ0FBQyxDQUMvQixnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FDdkMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUMvQixRQUFRLEVBQUUsQ0FBQTtBQUNiLG1CQUFhLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO0tBQ3hCO0dBQ0Y7O0FBRUQsVUFBUSxlQUFlLENBQUMsSUFBSTtBQUMxQixTQUFLLE1BQU07QUFDVCxlQUFTLENBQUMsSUFBSSxDQUFDLDZCQUFLLGVBQWUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQTtBQUM5QyxtQkFBYSxFQUFFLENBQUE7QUFDZixZQUFLO0FBQUEsQUFDUCxTQUFLLElBQUk7QUFDUCxlQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO0FBQ3BCLG1CQUFhLEVBQUUsQ0FBQTtBQUNmLFlBQUs7QUFBQSxBQUNQLFNBQUssTUFBTTtBQUNULGVBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUE7QUFDekIsbUJBQWEsRUFBRSxDQUFBO0FBQ2YsWUFBSztBQUFBLEFBQ1AsU0FBSyxNQUFNO0FBQ1QsZUFBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7QUFDM0MsbUJBQWEsRUFBRSxDQUFBO0FBQ2YsWUFBSztBQUFBLEFBQ1AsU0FBSyxZQUFZO0FBQ2YsVUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFBO0FBQ2pCLG1CQUFhLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFBO0FBQy9ELGVBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7QUFDdEIsWUFBSztBQUFBLEFBQ1AsU0FBSyxXQUFXO0FBQ2QsVUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFBO0FBQ2hCLGtCQUFZLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFBO0FBQzdELGVBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7QUFDckIsWUFBSztBQUFBLEFBQ1A7QUFBUyxZQUFLO0FBQUEsR0FDZjtBQUNELFNBQU8sT0FBTyxDQUFBO0NBQ2Y7O0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFO0FBQzdFLE1BQUksTUFBTSxDQUFDLE9BQU8sRUFBRSxJQUFJLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxJQUFJLEtBQUssVUFBVSxFQUFFO0FBQzdELFFBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLElBQUksa0JBQWtCLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsRUFBRTtBQUNsRyxVQUFNLElBQUksR0FBRyxPQUFPLENBQUMsY0FBYyxFQUFFLENBQ2xDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUNsQyxZQUFZLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQy9CLFFBQVEsRUFBRSxDQUFBO0FBQ2IsbUJBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7S0FDeEI7QUFDRCxXQUFNO0dBQ1A7O0FBRUQsTUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsSUFBSSxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLE9BQU8sRUFBRSxFQUFFLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFFO0FBQ2xHLFFBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FDbEMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQ2xDLFlBQVksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FDL0IsUUFBUSxFQUFFLENBQUE7QUFDYixpQkFBYSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtHQUN4Qjs7QUFFRCxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUE7O0FBRTlCLE1BQUksUUFBUSxDQUFDLElBQUksS0FBSyxNQUFNLElBQUksUUFBUSxDQUFDLElBQUksS0FBSyxNQUFNLEVBQUU7QUFDeEQsV0FBTTtHQUNQOztBQUVELE1BQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLElBQUksbUJBQW1CLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxFQUFFO0FBQ3hFLFFBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FDbEMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQ3ZDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FDeEIsWUFBWSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUMvQixRQUFRLEVBQUUsQ0FBQTtBQUNiLGlCQUFhLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO0dBQ3hCOztBQUVELE1BQU0sR0FBRyxHQUFHLDZCQUFLLFFBQVEsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUE7QUFDbkMsTUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFBO0FBQ3BDLE1BQUksY0FBYyxDQUFDLElBQUksS0FBSyxTQUFTLEVBQUU7QUFDckMsUUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtBQUNwQyxRQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxJQUFJLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxjQUFjLEVBQUUsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQUU7QUFDaEcsVUFBTSxJQUFJLEdBQUcsV0FBVyxDQUFDLGdCQUFnQixFQUFFLENBQ3hDLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxDQUNoQyxZQUFZLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQy9CLFFBQVEsRUFBRSxDQUFBO0FBQ2IsbUJBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7S0FDeEI7O0FBRUQsUUFBTSxZQUFZLEdBQUcsRUFBRSxDQUFBO0FBQ3ZCLGdCQUFZLENBQUMsTUFBTSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLGFBQWEsQ0FBQyxDQUFBO1FBQ2pFLEtBQUssR0FBSSxZQUFZOztBQUM1QixVQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFBO0dBQ3BCLE1BQU07O0FBRUwsVUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLFNBQVMsQ0FBQTtHQUN4QjtDQUNGOztBQUVELFNBQVMsYUFBYSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUU7QUFDdkUsU0FBTyxNQUFNLENBQUMsT0FBTyxFQUFFLEVBQUU7QUFDdkIsdUJBQW1CLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFBO0FBQ3JFLFFBQUksTUFBTSxDQUFDLE9BQU8sRUFBRSxFQUFFO0FBQ3BCLFVBQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQTtBQUMzQixjQUFRLEtBQUssQ0FBQyxJQUFJO0FBQ2hCLGFBQUssVUFBVTtBQUFFLGlCQUFNO0FBQ3ZCLGFBQUssS0FBSztBQUFFLGdCQUFLO0FBQ2pCO0FBQVMsZ0JBQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQTtPQUMzQjtLQUNGO0dBQ0Y7Q0FDRjs7QUFFRCxTQUFTLFlBQVksQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFO0FBQ3JFLE1BQUksS0FBSyxHQUFHLENBQUMsQ0FBQTtBQUNiLFNBQU8sTUFBTSxDQUFDLE9BQU8sRUFBRSxFQUFFO0FBQ3ZCLFFBQUksTUFBTSxDQUFDLE9BQU8sRUFBRSxFQUFFO0FBQ3BCLFVBQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQTtBQUMzQixVQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxJQUFJLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsWUFBWSxFQUFFLEVBQUUsS0FBSyxDQUFDLEVBQUU7QUFDM0YsWUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FDNUIsZ0JBQWdCLEVBQUUsQ0FDbEIsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQ3ZDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FDbkIsUUFBUSxFQUFFLENBQUE7QUFDYixxQkFBYSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtPQUN4QjtBQUNELGNBQVEsS0FBSyxDQUFDLElBQUk7QUFDaEIsYUFBSyxTQUFTO0FBQUUsaUJBQU07QUFDdEI7QUFBUyxnQkFBTSxDQUFDLFFBQVEsRUFBRSxDQUFBO09BQzNCO0tBQ0Y7O0FBRUQsUUFBTSxZQUFZLEdBQUcsRUFBRSxDQUFBO0FBQ3ZCLGdCQUFZLENBQUMsTUFBTSxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxhQUFhLENBQUMsQ0FBQTtRQUN4RSxLQUFLLEdBQUksWUFBWTs7QUFDNUIsU0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtBQUNqQixTQUFLLEVBQUUsQ0FBQTs7QUFFUCxRQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUUsRUFBRTtBQUNwQixVQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUE7QUFDM0IsVUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsSUFBSSxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFFO0FBQ3ZGLFlBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQzVCLGdCQUFnQixFQUFFLENBQ2xCLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUN2QixZQUFZLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQy9CLFFBQVEsRUFBRSxDQUFBO0FBQ2IscUJBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUE7T0FDeEI7QUFDRCxjQUFRLEtBQUssQ0FBQyxJQUFJO0FBQ2hCLGFBQUssU0FBUztBQUFFLGlCQUFNO0FBQ3RCLGFBQUssS0FBSztBQUFFLGdCQUFLO0FBQ2pCO0FBQVMsZ0JBQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQTtPQUMzQjtLQUNGO0dBQ0Y7Q0FDRjs7QUFFTSxTQUFTLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxRQUFRLEVBQUU7QUFDdEQsTUFBTSxNQUFNLEdBQUcsMEJBQW1CLFdBQVcsQ0FBQyxDQUFBOztBQUU5QyxNQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxFQUFFO0FBQ3JCLFdBQU8sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxDQUFBO0dBQ25FOztBQUVELE1BQU0sYUFBYSxHQUFHLHdCQUFpQixDQUFBO0FBQ3ZDLE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQTtBQUNoQyxNQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssWUFBWSxFQUFFO0FBQ3BDLFFBQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQTtBQUNqQixpQkFBYSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLHlCQUFrQixFQUFFLGFBQWEsQ0FBQyxDQUFBO0FBQzFFLFdBQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxhQUFhLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsQ0FBQTtHQUM5RixNQUFNLElBQUksVUFBVSxDQUFDLElBQUksS0FBSyxXQUFXLEVBQUU7QUFDMUMsUUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFBO0FBQ2hCLGdCQUFZLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUseUJBQWtCLEVBQUUsYUFBYSxDQUFDLENBQUE7QUFDeEUsV0FBTyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLGFBQWEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxDQUFBO0dBQzdGO0FBQ0QsU0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUE7Q0FDbkUiLCJmaWxlIjoiL1VzZXJzL3N1ZHByYXdhdC8uYXRvbS9wYWNrYWdlcy9hdXRvY29tcGxldGUtanNvbi9zcmMvc3RydWN0dXJlLXByb3ZpZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCdcblxuaW1wb3J0IHRyaW0gZnJvbSAnbG9kYXNoL3RyaW0nXG5pbXBvcnQgeyBBcnJheVRyYXZlcnNlciwgUG9zaXRpb25JbmZvLCBWYWx1ZUhvbGRlciB9IGZyb20gJy4vdXRpbHMnXG5pbXBvcnQgeyBUb2tlblR5cGUgfSBmcm9tICcuL3Rva2VuaXplcidcblxuY29uc3QgeyBTVFJJTkcsIE5VTEwsIFNZTUJPTCwgTlVNQkVSLCBCRUdJTl9PQkpFQ1QsIEVORF9PQkpFQ1QsIEJFR0lOX0FSUkFZLCBFTkRfQVJSQVksIEVORF9MQUJFTCwgQ09NTUEgfSA9IFRva2VuVHlwZVxuXG5mdW5jdGlvbiBpbnRlcnNlY3RzV2l0aFRva2VuKHBvc2l0aW9uLCB0b2tlbikge1xuICBjb25zdCB0Um93ID0gdG9rZW4ubGluZSAtIDFcbiAgY29uc3QgcFJvdyA9IHBvc2l0aW9uLnJvd1xuICBjb25zdCB0Q29sID0gdG9rZW4uY29sXG4gIGNvbnN0IHRMZW5ndGggPSB0b2tlbi5zcmMubGVuZ3RoXG4gIGNvbnN0IHBDb2wgPSBwb3NpdGlvbi5jb2x1bW5cblxuICBpZiAodG9rZW4udHlwZSA9PT0gU1RSSU5HKSB7XG4gICAgcmV0dXJuIHRSb3cgPT09IHBSb3cgJiYgdENvbCA8PSBwQ29sICYmIHRDb2wgKyB0TGVuZ3RoIC0gMSA+IHBDb2wgLy8gYXR0ZW50aW9uIHRvIFwiXCJcbiAgfVxuICByZXR1cm4gdFJvdyA9PT0gcFJvdyAmJiB0Q29sIDw9IHBDb2wgJiYgdENvbCArIHRMZW5ndGggPiBwQ29sXG5cbn1cblxuZnVuY3Rpb24gaXNCZXR3ZWVuVG9rZW5UeXBlKHBvc2l0aW9uLCBmaXJzdFRva2VuLCBzZWNvbmRUb2tlbikge1xuICBjb25zdCBwUm93ID0gcG9zaXRpb24ucm93XG4gIGNvbnN0IHBDb2wgPSBwb3NpdGlvbi5jb2x1bW5cbiAgY29uc3QgZlJvdyA9IGZpcnN0VG9rZW4ubGluZSAtIDFcbiAgY29uc3Qgc1JvdyA9IHNlY29uZFRva2VuLmxpbmUgLSAxXG4gIGNvbnN0IGZFbmQgPSBmaXJzdFRva2VuLmNvbCArIGZpcnN0VG9rZW4uc3JjLmxlbmd0aCAtIDFcbiAgY29uc3Qgc1N0YXJ0ID0gc2Vjb25kVG9rZW4uY29sXG5cbiAgLy8gY3Vyc29yIHBvc2l0aW9uIGFuZCB0aGUgMiB0b2tlbnMgYXJlIG9uIHRoZSBzYW1lIGxpbmVcbiAgaWYgKHBSb3cgPT09IGZSb3cgJiYgcFJvdyA9PT0gc1Jvdykge1xuICAgIHJldHVybiBwQ29sID49IGZFbmQgJiYgcENvbCA8IHNTdGFydFxuICB9XG4gIC8vIGN1cnNvciBwb3NpdGlvbiBpcyBub3Qgb24gdGhlIHNhbWUgbGluZSBhcyB0aGUgMiBvdGhlciB0b2tlbnMgYnV0IGlzIGJldHdlZW4gdGhlbVxuICByZXR1cm4gKHBSb3cgPiBmUm93ICYmIHBSb3cgPCBzUm93KSAvLyBmaXJzdFRva2VuIFxcbisgcG9zaXRpb24gXFxuKyBzZWNvbmRUb2tlblxuICAgIHx8IChwUm93ID09PSBmUm93ICYmIHBSb3cgPCBzUm93ICYmIHBDb2wgPj0gZkVuZCkgLy8gZmlzdFRva2VuIHBvc2l0aW9uIFxcbisgc2Vjb25kVG9rZW5cbiAgICB8fCAocFJvdyA+IGZSb3cgJiYgcFJvdyA9PT0gc1JvdyAmJiBwQ29sIDwgc1N0YXJ0KSAvLyBmaXJzdFRva2VuIFxcbisgcG9zaXRpb24gc2Vjb25kVG9rZW5cbn1cblxuZnVuY3Rpb24gY29uc3VtZVZhbHVlKHRva2VucywgY29udGFpbmVyLCBwb3NpdGlvbiwgcG9zSW5mbywgcG9zSW5mb0hvbGRlcikge1xuICBjb25zdCB2YWx1ZVN0YXJ0VG9rZW4gPSB0b2tlbnMubmV4dCgpXG5cbiAgZnVuY3Rpb24gY2hlY2tQb3NpdGlvbigpIHtcbiAgICBpZiAoIXBvc0luZm9Ib2xkZXIuaGFzVmFsdWUoKSAmJiBpbnRlcnNlY3RzV2l0aFRva2VuKHBvc2l0aW9uLCB2YWx1ZVN0YXJ0VG9rZW4pKSB7XG4gICAgICBjb25zdCBpbmZvID0gcG9zSW5mby5zZXRWYWx1ZVBvc2l0aW9uKClcbiAgICAgICAgLnNldEVkaXRlZFRva2VuKHZhbHVlU3RhcnRUb2tlbilcbiAgICAgICAgLnNldFByZXZpb3VzVG9rZW4odG9rZW5zLnBlZWtQcmV2aW91cygpKVxuICAgICAgICAuc2V0TmV4dFRva2VuKHRva2Vucy5wZWVrTmV4dCgpKVxuICAgICAgICAudG9PYmplY3QoKVxuICAgICAgcG9zSW5mb0hvbGRlci5zZXQoaW5mbylcbiAgICB9XG4gIH1cblxuICBzd2l0Y2ggKHZhbHVlU3RhcnRUb2tlbi50eXBlKSB7XG4gICAgY2FzZSBTVFJJTkc6XG4gICAgICBjb250YWluZXIucHVzaCh0cmltKHZhbHVlU3RhcnRUb2tlbi5zcmMsICdcIicpKVxuICAgICAgY2hlY2tQb3NpdGlvbigpXG4gICAgICBicmVha1xuICAgIGNhc2UgTlVMTDpcbiAgICAgIGNvbnRhaW5lci5wdXNoKG51bGwpXG4gICAgICBjaGVja1Bvc2l0aW9uKClcbiAgICAgIGJyZWFrXG4gICAgY2FzZSBTWU1CT0w6XG4gICAgICBjb250YWluZXIucHVzaCh1bmRlZmluZWQpXG4gICAgICBjaGVja1Bvc2l0aW9uKClcbiAgICAgIGJyZWFrXG4gICAgY2FzZSBOVU1CRVI6XG4gICAgICBjb250YWluZXIucHVzaChOdW1iZXIodmFsdWVTdGFydFRva2VuLnNyYykpXG4gICAgICBjaGVja1Bvc2l0aW9uKClcbiAgICAgIGJyZWFrXG4gICAgY2FzZSBCRUdJTl9PQkpFQ1Q6XG4gICAgICBjb25zdCBvYmplY3QgPSB7fVxuICAgICAgY29uc3VtZU9iamVjdChvYmplY3QsIHRva2VucywgcG9zaXRpb24sIHBvc0luZm8sIHBvc0luZm9Ib2xkZXIpXG4gICAgICBjb250YWluZXIucHVzaChvYmplY3QpXG4gICAgICBicmVha1xuICAgIGNhc2UgQkVHSU5fQVJSQVk6XG4gICAgICBjb25zdCBhcnJheSA9IFtdXG4gICAgICBjb25zdW1lQXJyYXkoYXJyYXksIHRva2VucywgcG9zaXRpb24sIHBvc0luZm8sIHBvc0luZm9Ib2xkZXIpXG4gICAgICBjb250YWluZXIucHVzaChhcnJheSlcbiAgICAgIGJyZWFrXG4gICAgZGVmYXVsdDogYnJlYWtcbiAgfVxuICByZXR1cm4gcG9zSW5mb1xufVxuXG5mdW5jdGlvbiBjb25zdW1lS2V5VmFsdWVQYWlyKG9iamVjdCwgdG9rZW5zLCBwb3NpdGlvbiwgcG9zSW5mbywgcG9zSW5mb0hvbGRlcikge1xuICBpZiAodG9rZW5zLmhhc05leHQoKSAmJiB0b2tlbnMucGVla05leHQoKS50eXBlID09PSBFTkRfT0JKRUNUKSB7XG4gICAgaWYgKCFwb3NJbmZvSG9sZGVyLmhhc1ZhbHVlKCkgJiYgaXNCZXR3ZWVuVG9rZW5UeXBlKHBvc2l0aW9uLCB0b2tlbnMuY3VycmVudCgpLCB0b2tlbnMucGVla05leHQoKSkpIHtcbiAgICAgIGNvbnN0IGluZm8gPSBwb3NJbmZvLnNldEtleVBvc2l0aW9uKClcbiAgICAgICAgLnNldFByZXZpb3VzVG9rZW4odG9rZW5zLmN1cnJlbnQoKSlcbiAgICAgICAgLnNldE5leHRUb2tlbih0b2tlbnMucGVla05leHQoKSlcbiAgICAgICAgLnRvT2JqZWN0KClcbiAgICAgIHBvc0luZm9Ib2xkZXIuc2V0KGluZm8pXG4gICAgfVxuICAgIHJldHVyblxuICB9XG5cbiAgaWYgKCFwb3NJbmZvSG9sZGVyLmhhc1ZhbHVlKCkgJiYgaXNCZXR3ZWVuVG9rZW5UeXBlKHBvc2l0aW9uLCB0b2tlbnMuY3VycmVudCgpLCB0b2tlbnMucGVla05leHQoKSkpIHtcbiAgICBjb25zdCBpbmZvID0gcG9zSW5mby5zZXRLZXlQb3NpdGlvbigpXG4gICAgICAuc2V0UHJldmlvdXNUb2tlbih0b2tlbnMuY3VycmVudCgpKVxuICAgICAgLnNldE5leHRUb2tlbih0b2tlbnMucGVla05leHQoKSlcbiAgICAgIC50b09iamVjdCgpXG4gICAgcG9zSW5mb0hvbGRlci5zZXQoaW5mbylcbiAgfVxuXG4gIGNvbnN0IGtleVRva2VuID0gdG9rZW5zLm5leHQoKVxuICAvLyBGaXJzdCB0b2tlbiBpcyBub3QgYSBrZXksIHNraXAgaXQuXG4gIGlmIChrZXlUb2tlbi50eXBlICE9PSBTVFJJTkcgJiYga2V5VG9rZW4udHlwZSAhPT0gU1lNQk9MKSB7XG4gICAgcmV0dXJuXG4gIH1cblxuICBpZiAoIXBvc0luZm9Ib2xkZXIuaGFzVmFsdWUoKSAmJiBpbnRlcnNlY3RzV2l0aFRva2VuKHBvc2l0aW9uLCBrZXlUb2tlbikpIHtcbiAgICBjb25zdCBpbmZvID0gcG9zSW5mby5zZXRLZXlQb3NpdGlvbigpXG4gICAgICAuc2V0UHJldmlvdXNUb2tlbih0b2tlbnMucGVla1ByZXZpb3VzKCkpXG4gICAgICAuc2V0RWRpdGVkVG9rZW4oa2V5VG9rZW4pXG4gICAgICAuc2V0TmV4dFRva2VuKHRva2Vucy5wZWVrTmV4dCgpKVxuICAgICAgLnRvT2JqZWN0KClcbiAgICBwb3NJbmZvSG9sZGVyLnNldChpbmZvKVxuICB9XG5cbiAgY29uc3Qga2V5ID0gdHJpbShrZXlUb2tlbi5zcmMsICdcIicpXG4gIGNvbnN0IHNlcGFyYXRvclRva2VuID0gdG9rZW5zLm5leHQoKVxuICBpZiAoc2VwYXJhdG9yVG9rZW4udHlwZSA9PT0gRU5EX0xBQkVMKSB7XG4gICAgY29uc3QgcGF0aFdpdGhLZXkgPSBwb3NJbmZvLmFkZChrZXkpXG4gICAgaWYgKCFwb3NJbmZvSG9sZGVyLmhhc1ZhbHVlKCkgJiYgaXNCZXR3ZWVuVG9rZW5UeXBlKHBvc2l0aW9uLCBzZXBhcmF0b3JUb2tlbiwgdG9rZW5zLnBlZWtOZXh0KCkpKSB7XG4gICAgICBjb25zdCBpbmZvID0gcGF0aFdpdGhLZXkuc2V0VmFsdWVQb3NpdGlvbigpXG4gICAgICAgIC5zZXRQcmV2aW91c1Rva2VuKHNlcGFyYXRvclRva2VuKVxuICAgICAgICAuc2V0TmV4dFRva2VuKHRva2Vucy5wZWVrTmV4dCgpKVxuICAgICAgICAudG9PYmplY3QoKVxuICAgICAgcG9zSW5mb0hvbGRlci5zZXQoaW5mbylcbiAgICB9XG4gICAgLy8gQ29tcGxldGUga2V5LXZhbHVlIHBhaXJcbiAgICBjb25zdCB2YWxDb250YWluZXIgPSBbXVxuICAgIGNvbnN1bWVWYWx1ZSh0b2tlbnMsIHZhbENvbnRhaW5lciwgcG9zaXRpb24sIHBhdGhXaXRoS2V5LCBwb3NJbmZvSG9sZGVyKVxuICAgIGNvbnN0IFt2YWx1ZV0gPSB2YWxDb250YWluZXJcbiAgICBvYmplY3Rba2V5XSA9IHZhbHVlXG4gIH0gZWxzZSB7XG4gICAgLy8gc2VwYXJhdG9yIGluIHBsYWNlLCB2YWx1ZSBwcm9iYWJseSB1bmRlciBlZGl0aW5nXG4gICAgb2JqZWN0W2tleV0gPSB1bmRlZmluZWRcbiAgfVxufVxuXG5mdW5jdGlvbiBjb25zdW1lT2JqZWN0KG9iamVjdCwgdG9rZW5zLCBwb3NpdGlvbiwgcG9zSW5mbywgcG9zSW5mb0hvbGRlcikge1xuICB3aGlsZSAodG9rZW5zLmhhc05leHQoKSkge1xuICAgIGNvbnN1bWVLZXlWYWx1ZVBhaXIob2JqZWN0LCB0b2tlbnMsIHBvc2l0aW9uLCBwb3NJbmZvLCBwb3NJbmZvSG9sZGVyKVxuICAgIGlmICh0b2tlbnMuaGFzTmV4dCgpKSB7XG4gICAgICBjb25zdCB0b2tlbiA9IHRva2Vucy5uZXh0KClcbiAgICAgIHN3aXRjaCAodG9rZW4udHlwZSkge1xuICAgICAgICBjYXNlIEVORF9PQkpFQ1Q6IHJldHVybiAvLyBlbmQgb2Ygb2JqZWN0XG4gICAgICAgIGNhc2UgQ09NTUE6IGJyZWFrIC8vICcsJyByZWFkIC0gbm90aGluZyBlbHNlIHRvIGRvXG4gICAgICAgIGRlZmF1bHQ6IHRva2Vucy5wcmV2aW91cygpIC8vIHNvbWV0aGluZyBlbHNlLCBnbyBiYWNrXG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGNvbnN1bWVBcnJheShhcnJheSwgdG9rZW5zLCBwb3NpdGlvbiwgcG9zSW5mbywgcG9zSW5mb0hvbGRlcikge1xuICBsZXQgaW5kZXggPSAwXG4gIHdoaWxlICh0b2tlbnMuaGFzTmV4dCgpKSB7XG4gICAgaWYgKHRva2Vucy5oYXNOZXh0KCkpIHtcbiAgICAgIGNvbnN0IHRva2VuID0gdG9rZW5zLm5leHQoKVxuICAgICAgaWYgKCFwb3NJbmZvSG9sZGVyLmhhc1ZhbHVlKCkgJiYgaXNCZXR3ZWVuVG9rZW5UeXBlKHBvc2l0aW9uLCB0b2tlbnMucGVla1ByZXZpb3VzKCksIHRva2VuKSkge1xuICAgICAgICBjb25zdCBpbmZvID0gcG9zSW5mby5hZGQoaW5kZXgpXG4gICAgICAgICAgLnNldFZhbHVlUG9zaXRpb24oKVxuICAgICAgICAgIC5zZXRQcmV2aW91c1Rva2VuKHRva2Vucy5wZWVrUHJldmlvdXMoKSlcbiAgICAgICAgICAuc2V0TmV4dFRva2VuKHRva2VuKVxuICAgICAgICAgIC50b09iamVjdCgpXG4gICAgICAgIHBvc0luZm9Ib2xkZXIuc2V0KGluZm8pXG4gICAgICB9XG4gICAgICBzd2l0Y2ggKHRva2VuLnR5cGUpIHtcbiAgICAgICAgY2FzZSBFTkRfQVJSQVk6IHJldHVybiAvLyBlbmQgb2YgYXJyYXlcbiAgICAgICAgZGVmYXVsdDogdG9rZW5zLnByZXZpb3VzKCkgLy8gc29tZXRoaW5nIGVsc2UsIGdvIGJhY2tcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCB2YWxDb250YWluZXIgPSBbXVxuICAgIGNvbnN1bWVWYWx1ZSh0b2tlbnMsIHZhbENvbnRhaW5lciwgcG9zaXRpb24sIHBvc0luZm8uYWRkKGluZGV4KSwgcG9zSW5mb0hvbGRlcilcbiAgICBjb25zdCBbdmFsdWVdID0gdmFsQ29udGFpbmVyXG4gICAgYXJyYXkucHVzaCh2YWx1ZSlcbiAgICBpbmRleCsrXG5cbiAgICBpZiAodG9rZW5zLmhhc05leHQoKSkge1xuICAgICAgY29uc3QgdG9rZW4gPSB0b2tlbnMubmV4dCgpXG4gICAgICBpZiAoIXBvc0luZm9Ib2xkZXIuaGFzVmFsdWUoKSAmJiBpc0JldHdlZW5Ub2tlblR5cGUocG9zaXRpb24sIHRva2VuLCB0b2tlbnMucGVla05leHQoKSkpIHtcbiAgICAgICAgY29uc3QgaW5mbyA9IHBvc0luZm8uYWRkKGluZGV4KVxuICAgICAgICAgIC5zZXRWYWx1ZVBvc2l0aW9uKClcbiAgICAgICAgICAuc2V0UHJldmlvdXNUb2tlbih0b2tlbilcbiAgICAgICAgICAuc2V0TmV4dFRva2VuKHRva2Vucy5wZWVrTmV4dCgpKVxuICAgICAgICAgIC50b09iamVjdCgpXG4gICAgICAgIHBvc0luZm9Ib2xkZXIuc2V0KGluZm8pXG4gICAgICB9XG4gICAgICBzd2l0Y2ggKHRva2VuLnR5cGUpIHtcbiAgICAgICAgY2FzZSBFTkRfQVJSQVk6IHJldHVybiAvLyBlbmQgb2Ygb2JqZWN0XG4gICAgICAgIGNhc2UgQ09NTUE6IGJyZWFrIC8vICcsJyByZWFkIC0gbm90aGluZyBlbHNlIHRvIGRvXG4gICAgICAgIGRlZmF1bHQ6IHRva2Vucy5wcmV2aW91cygpIC8vIHNvbWV0aGluZyBlbHNlLCBnbyBiYWNrXG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcm92aWRlU3RydWN0dXJlKHRva2Vuc0FycmF5LCBwb3NpdGlvbikge1xuICBjb25zdCB0b2tlbnMgPSBuZXcgQXJyYXlUcmF2ZXJzZXIodG9rZW5zQXJyYXkpXG5cbiAgaWYgKCF0b2tlbnMuaGFzTmV4dCgpKSB7XG4gICAgcmV0dXJuIHsgY29udGVudHM6IG51bGwsIHBvc2l0aW9uSW5mbzogbnVsbCwgdG9rZW5zOiB0b2tlbnNBcnJheSB9IC8vIG5vIHRva2Vuc1xuICB9XG5cbiAgY29uc3QgcG9zSW5mb0hvbGRlciA9IG5ldyBWYWx1ZUhvbGRlcigpXG4gIGNvbnN0IGZpcnN0VG9rZW4gPSB0b2tlbnMubmV4dCgpXG4gIGlmIChmaXJzdFRva2VuLnR5cGUgPT09IEJFR0lOX09CSkVDVCkge1xuICAgIGNvbnN0IG9iamVjdCA9IHt9XG4gICAgY29uc3VtZU9iamVjdChvYmplY3QsIHRva2VucywgcG9zaXRpb24sIG5ldyBQb3NpdGlvbkluZm8oKSwgcG9zSW5mb0hvbGRlcilcbiAgICByZXR1cm4geyBjb250ZW50czogb2JqZWN0LCBwb3NpdGlvbkluZm86IHBvc0luZm9Ib2xkZXIuZ2V0T3JFbHNlKG51bGwpLCB0b2tlbnM6IHRva2Vuc0FycmF5IH1cbiAgfSBlbHNlIGlmIChmaXJzdFRva2VuLnR5cGUgPT09IEJFR0lOX0FSUkFZKSB7XG4gICAgY29uc3QgYXJyYXkgPSBbXVxuICAgIGNvbnN1bWVBcnJheShhcnJheSwgdG9rZW5zLCBwb3NpdGlvbiwgbmV3IFBvc2l0aW9uSW5mbygpLCBwb3NJbmZvSG9sZGVyKVxuICAgIHJldHVybiB7IGNvbnRlbnRzOiBhcnJheSwgcG9zaXRpb25JbmZvOiBwb3NJbmZvSG9sZGVyLmdldE9yRWxzZShudWxsKSwgdG9rZW5zOiB0b2tlbnNBcnJheSB9XG4gIH1cbiAgcmV0dXJuIHsgY29udGVudHM6IG51bGwsIHBvc2l0aW9uSW5mbzogbnVsbCwgdG9rZW5zOiB0b2tlbnNBcnJheSB9IC8vIGRvbid0IGJvdGhlciB3aXRoIHN0cmluZ3MsIG51bWJlcnMsIGV0Yy4gZm9yIG5vd1xufVxuIl19