var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

var _formatJs = require('./format.js');

'use babel';

var server_config = require('./../config/server-schema.json');
var folder_config = require('./../config/folder-schema.json');

var atom = global.atom;
var FileSystem = require('fs-plus');
var Electron = require('electron');
var XMLParser = require('xml-js');
var Storage = require('./storage.js');

var Import = (function () {
  function Import() {
    _classCallCheck(this, Import);

    var self = this;

    self.onError = function (error) {};
    self.onWarning = function (error) {};
    self.onFinished = function (statistic) {};
  }

  _createClass(Import, [{
    key: 'import',
    value: function _import() {
      var self = this;

      Electron.remote.dialog.showOpenDialog(null, { title: 'Select file to import', defaultPath: Electron.remote.app.getPath("desktop"), buttonLabel: 'Import', filters: [{ name: 'All Files', extensions: ['*'] }, { name: 'FileZilla', extensions: ['xml'] }, { name: 'PHP Storm', extensions: ['xml'] }, { name: 'Remote-Ftp', extensions: ['ftpconfig'] }], properties: ['openFile', 'showHiddenFiles'] }, function (filePaths, bookmarks) {
        if (filePaths) {
          filePaths.forEach(function (filePath, index) {
            if (filePath.toLowerCase().endsWith('.xml') || filePath.toLowerCase().endsWith('.ftpconfig')) {
              FileSystem.readFile(filePath, function (error, data) {
                if (error) {
                  self.onError(new Error('Opening file failed'));
                } else {
                  if (filePath.toLowerCase().endsWith('.xml')) {
                    try {
                      var json = XMLParser.xml2js(data, { compact: true });
                      if (typeof json['FileZilla3'] !== 'undefined') {
                        self.onFinished(self.importFileZilla3(json['FileZilla3']['Servers'], null));
                      } else if (typeof json['application']['component']['option'] !== 'undefined') {
                        self.onFinished(self.importPHPStorm(json['application']['component']['option']['webServer'], null));
                      }
                    } catch (error) {
                      self.onError(new Error('Parsing file failed'));
                    }
                  } else if (filePath.toLowerCase().endsWith('.ftpconfig')) {
                    try {
                      var json = JSON.parse(data);
                      self.onFinished(self.importFtpConfig(json));
                    } catch (error) {
                      self.onError(new Error('Parsing file failed'));
                    }
                  }
                }
              });
            } else {
              self.onError(new Error('Unknown file format'));
            }
          });
        } else {
          self.onWarning(new Error('No import file has not been selected'));
        }
      });
    }
  }, {
    key: 'importFileZilla3',
    value: function importFileZilla3(data, parent) {
      var self = this;
      var createdServers = 0;
      var updatedServers = 0;
      var createdFolders = 0;

      if (typeof data['Server'] !== 'undefined') {
        if (!Array.isArray(data['Server'])) {
          data['Server'] = [data['Server']];
        }
        data['Server'].forEach(function (serverData, index) {
          var newconfig = Storage.getServerByName(serverData['Name']['_text']);
          var newServer = true;

          if (typeof newconfig === 'undefined') {
            newconfig = JSON.parse(JSON.stringify(server_config));
            createdServers++;
          } else {
            updatedServers++;
            newServer = false;
          }

          newconfig.name = serverData['Name']['_text'];
          newconfig.host = serverData['Host']['_text'];
          if (typeof serverData['Port'] !== 'undefined') newconfig.port = serverData['Port']['_text'];
          if (typeof serverData['User'] !== 'undefined') newconfig.user = serverData['User']['_text'];
          if (typeof serverData['Pass'] !== 'undefined') {
            if (serverData['Pass']['_attributes']['encoding'] == 'base64') {
              newconfig.password = Buffer.from(serverData['Pass']['_text'], serverData['Pass']['_attributes']['encoding']).toString();
            } else if (serverData['Pass']['_attributes']['encoding'] == 'crypt') {
              atom.notifications.addWarning('Not implemented import from FileZilla!', {
                detail: "Filezilla import with crypted password has not been implemented! Saved empty password for " + newconfig.name + "!",
                dismissable: true
              });
            } else if (serverData['Pass']['_attributes']['encoding'] == 'plain') {
              newconfig.password = serverData['Pass']['_text'], serverData['Pass']['_attributes']['encoding'];
            } else {
              atom.notifications.addWarning('Not recognized encoding method for password!', {
                detail: "Couldn't recognize password type for server " + newconfig.name + " in FileZilla import file. Saved empty password.",
                dismissable: true
              });
            }
          }
          newconfig.sftp = serverData['Protocol']['_text'] == '1';
          newconfig.remote = serverData['RemoteDir']['_text'] || '';

          // Convert FileZilla path
          if (newconfig.remote.length > 0) {
            var parts = newconfig.remote.split(' ');
            var segments = ['/'];

            // Remove type and stop
            var type = parts.shift();
            var _stop = parts.shift();

            // parse segments
            while (parts.length > 0) {
              var segmentLength = parts.shift();
              segments.push(parts.shift());
            }
            newconfig.remote = (0, _formatJs.normalize)(segments.join('/'));
          }

          newconfig.parent = parent;
          if (newServer) {
            Storage.addServer(newconfig);
          }
        });
      }

      if (typeof data['Folder'] !== 'undefined') {
        if (!Array.isArray(data['Folder'])) {
          data['Folder'] = [data['Folder']];
        }
        data['Folder'].forEach(function (folderData, index) {
          var newconfig = Storage.getFolderByName(folderData['_text']);
          if (typeof newconfig === 'undefined') {
            newconfig = JSON.parse(JSON.stringify(folder_config));
            newconfig.name = folderData['_text'];
            newconfig.parent = parent;
            Storage.addFolder(newconfig);
            createdFolders++;
          }
          var imported = self.importFileZilla3(folderData, newconfig.id);
          createdServers += imported.createdServers;
          updatedServers += imported.updatedServers;
          createdFolders += imported.createdFolders;
        });
      }

      return { createdServers: createdServers, updatedServers: updatedServers, createdFolders: createdFolders };
    }
  }, {
    key: 'importFtpConfig',
    value: function importFtpConfig(data) {
      var self = this;
      var createdServers = 0;
      var updatedServers = 0;

      var name = (typeof data['user'] !== 'undefined' ? data['user'] + '@' : '') + data['host'];
      var newconfig = Storage.getServerByName(name);
      if (typeof newconfig === 'undefined') {
        newconfig = JSON.parse(JSON.stringify(server_config));
        createdServers++;
      } else {
        updatedServers++;
      }
      newconfig.name = name;
      newconfig.host = data['host'];
      if (typeof data['port'] !== 'undefined') newconfig.port = data['port'];
      if (typeof data['user'] !== 'undefined') newconfig.user = data['user'];
      if (typeof data['pass'] !== 'undefined') newconfig.password = data['pass'];
      newconfig.sftp = data['protocol'] == 'sftp';
      newconfig.remote = data['remote'];
      if (createdServers > 0) {
        Storage.addServer(newconfig);
      }

      return { createdServers: createdServers, updatedServers: updatedServers, createdFolders: 0 };
    }
  }, {
    key: 'importPHPStorm',
    value: function importPHPStorm(data) {
      var self = this;
      var createdServers = 0;
      var updatedServers = 0;

      data.forEach(function (serverData, index) {
        var newconfig = Storage.getServerByName(serverData['_attributes']['name']);
        var newServer = true;
        if (typeof newconfig === 'undefined') {
          newconfig = JSON.parse(JSON.stringify(server_config));
          createdServers++;
        } else {
          updatedServers++;
          newServer = false;
        }
        newconfig.name = serverData['_attributes']['name'];
        newconfig.host = serverData['fileTransfer']['_attributes']['host'];
        if (typeof serverData['fileTransfer']['_attributes']['port'] !== 'undefined') newconfig.port = serverData['fileTransfer']['_attributes']['port'];
        newconfig.sftp = serverData['fileTransfer']['_attributes']['accessType'] == 'SFTP';
        newconfig.remote = serverData['fileTransfer']['_attributes']['rootFolder'] || '';
        if (newServer) {
          Storage.addServer(newconfig);
        }
      });

      return { createdServers: createdServers, updatedServers: updatedServers, createdFolders: 0 };
    }
  }]);

  return Import;
})();

module.exports = Import;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9zdWRwcmF3YXQvLmF0b20vcGFja2FnZXMvZnRwLXJlbW90ZS1lZGl0L2xpYi9oZWxwZXIvaW1wb3J0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7d0JBRTBCLGFBQWE7O0FBRnZDLFdBQVcsQ0FBQzs7QUFJWixJQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztBQUNoRSxJQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsZ0NBQWdDLENBQUMsQ0FBQzs7QUFFaEUsSUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztBQUN6QixJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDdEMsSUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ3JDLElBQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNwQyxJQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7O0lBRWxDLE1BQU07QUFDQyxXQURQLE1BQU0sR0FDSTswQkFEVixNQUFNOztBQUVSLFFBQU0sSUFBSSxHQUFHLElBQUksQ0FBQzs7QUFFbEIsUUFBSSxDQUFDLE9BQU8sR0FBRyxVQUFDLEtBQUssRUFBSyxFQUFHLENBQUM7QUFDOUIsUUFBSSxDQUFDLFNBQVMsR0FBRyxVQUFDLEtBQUssRUFBSyxFQUFHLENBQUM7QUFDaEMsUUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFDLFNBQVMsRUFBSyxFQUFHLENBQUM7R0FDdEM7O2VBUEcsTUFBTTs7V0FTSixtQkFBRztBQUNQLFVBQU0sSUFBSSxHQUFHLElBQUksQ0FBQzs7QUFFbEIsY0FBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxFQUFFLEtBQUssRUFBRSx1QkFBdUIsRUFBRSxXQUFXLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFNBQVMs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QztBQUNuRCxpQkFBUyxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDbkUsWUFBSSxPQUFPLFVBQVUsQ0FBQyxjQUFjLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxXQUFXLEVBQzFFLFNBQVMsQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDLGNBQWMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3JFLGlCQUFTLENBQUMsSUFBSSxHQUFJLFVBQVUsQ0FBQyxjQUFjLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxZQUFZLENBQUMsSUFBSSxNQUFNLEFBQUMsQ0FBQztBQUNyRixpQkFBUyxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ2pGLFlBQUksU0FBUyxFQUFFO0FBQ2IsaUJBQU8sQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDOUI7T0FDRixDQUFDLENBQUM7O0FBRUgsYUFBTyxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsY0FBYyxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsQ0FBQyxFQUFFLENBQUM7S0FDOUY7OztTQTNNRyxNQUFNOzs7QUE2TVosTUFBTSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMiLCJmaWxlIjoiL1VzZXJzL3N1ZHByYXdhdC8uYXRvbS9wYWNrYWdlcy9mdHAtcmVtb3RlLWVkaXQvbGliL2hlbHBlci9pbXBvcnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcblxuaW1wb3J0IHsgbm9ybWFsaXplIH0gZnJvbSAnLi9mb3JtYXQuanMnO1xuXG5jb25zdCBzZXJ2ZXJfY29uZmlnID0gcmVxdWlyZSgnLi8uLi9jb25maWcvc2VydmVyLXNjaGVtYS5qc29uJyk7XG5jb25zdCBmb2xkZXJfY29uZmlnID0gcmVxdWlyZSgnLi8uLi9jb25maWcvZm9sZGVyLXNjaGVtYS5qc29uJyk7XG5cbmNvbnN0IGF0b20gPSBnbG9iYWwuYXRvbTtcbmNvbnN0IEZpbGVTeXN0ZW0gPSByZXF1aXJlKCdmcy1wbHVzJyk7XG5jb25zdCBFbGVjdHJvbiA9IHJlcXVpcmUoJ2VsZWN0cm9uJyk7XG5jb25zdCBYTUxQYXJzZXIgPSByZXF1aXJlKCd4bWwtanMnKTtcbmNvbnN0IFN0b3JhZ2UgPSByZXF1aXJlKCcuL3N0b3JhZ2UuanMnKTtcblxuY2xhc3MgSW1wb3J0IHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICBzZWxmLm9uRXJyb3IgPSAoZXJyb3IpID0+IHsgfTtcbiAgICBzZWxmLm9uV2FybmluZyA9IChlcnJvcikgPT4geyB9O1xuICAgIHNlbGYub25GaW5pc2hlZCA9IChzdGF0aXN0aWMpID0+IHsgfTtcbiAgfVxuXG4gIGltcG9ydCgpIHtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcblxuICAgIEVsZWN0cm9uLnJlbW90ZS5kaWFsb2cuc2hvd09wZW5EaWFsb2cobnVsbCwgeyB0aXRsZTogJ1NlbGVjdCBmaWxlIHRvIGltcG9ydCcsIGRlZmF1bHRQYXRoOiBFbGVjdHJvbi5yZW1vdGUuYXBwLmdldFBhdGgoXCJkZXNrdG9wXCIpLCBidXR0b25MYWJlbDogJ0ltcG9ydCcsIGZpbHRlcnM6IFt7IG5hbWU6ICdBbGwgRmlsZXMnLCBleHRlbnNpb25zOiBbJyonXSB9LCB7IG5hbWU6ICdGaWxlWmlsbGEnLCBleHRlbnNpb25zOiBbJ3htbCddIH0sIHsgbmFtZTogJ1BIUCBTdG9ybScsIGV4dGVuc2lvbnM6IFsneG1sJ10gfSwgeyBuYW1lOiAnUmVtb3RlLUZ0cCcsIGV4dGVuc2lvbnM6IFsnZnRwY29uZmlnJ10gfV0sIHByb3BlcnRpZXM6IFsnb3BlbkZpbGUnLCAnc2hvd0hpZGRlbkZpbGVzJ10gfSwgKGZpbGVQYXRocywgYm9va21hcmtzKSA9PiB7XG4gICAgICBpZiAoZmlsZVBhdGhzKSB7XG4gICAgICAgIGZpbGVQYXRocy5mb3JFYWNoKChmaWxlUGF0aCwgaW5kZXgpID0+IHtcbiAgICAgICAgICBpZiAoZmlsZVBhdGgudG9Mb3dlckNhc2UoKS5lbmRzV2l0aCgnLnhtbCcpIHx8IGZpbGVQYXRoLnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoJy5mdHBjb25maWcnKSkge1xuICAgICAgICAgICAgRmlsZVN5c3RlbS5yZWFkRmlsZShmaWxlUGF0aCwgZnVuY3Rpb24gKGVycm9yLCBkYXRhKSB7XG4gICAgICAgICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgICAgIHNlbGYub25FcnJvcihuZXcgRXJyb3IoJ09wZW5pbmcgZmlsZSBmYWlsZWQnKSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKGZpbGVQYXRoLnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoJy54bWwnKSkge1xuICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QganNvbiA9IFhNTFBhcnNlci54bWwyanMoZGF0YSwgeyBjb21wYWN0OiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGpzb25bJ0ZpbGVaaWxsYTMnXSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICBzZWxmLm9uRmluaXNoZWQoc2VsZi5pbXBvcnRGaWxlWmlsbGEzKGpzb25bJ0ZpbGVaaWxsYTMnXVsnU2VydmVycyddLCBudWxsKSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGpzb25bJ2FwcGxpY2F0aW9uJ11bJ2NvbXBvbmVudCddWydvcHRpb24nXSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICBzZWxmLm9uRmluaXNoZWQoc2VsZi5pbXBvcnRQSFBTdG9ybShqc29uWydhcHBsaWNhdGlvbiddWydjb21wb25lbnQnXVsnb3B0aW9uJ11bJ3dlYlNlcnZlciddLCBudWxsKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGYub25FcnJvcihuZXcgRXJyb3IoJ1BhcnNpbmcgZmlsZSBmYWlsZWQnKSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmaWxlUGF0aC50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKCcuZnRwY29uZmlnJykpIHtcbiAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGpzb24gPSBKU09OLnBhcnNlKGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICBzZWxmLm9uRmluaXNoZWQoc2VsZi5pbXBvcnRGdHBDb25maWcoanNvbikpO1xuICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5vbkVycm9yKG5ldyBFcnJvcignUGFyc2luZyBmaWxlIGZhaWxlZCcpKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzZWxmLm9uRXJyb3IobmV3IEVycm9yKCdVbmtub3duIGZpbGUgZm9ybWF0JykpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzZWxmLm9uV2FybmluZyhuZXcgRXJyb3IoJ05vIGltcG9ydCBmaWxlIGhhcyBub3QgYmVlbiBzZWxlY3RlZCcpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGltcG9ydEZpbGVaaWxsYTMoZGF0YSwgcGFyZW50KSB7XG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgbGV0IGNyZWF0ZWRTZXJ2ZXJzID0gMDtcbiAgICBsZXQgdXBkYXRlZFNlcnZlcnMgPSAwO1xuICAgIGxldCBjcmVhdGVkRm9sZGVycyA9IDA7XG5cbiAgICBpZiAodHlwZW9mIGRhdGFbJ1NlcnZlciddICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGRhdGFbJ1NlcnZlciddKSkge1xuICAgICAgICBkYXRhWydTZXJ2ZXInXSA9IFtkYXRhWydTZXJ2ZXInXV07XG4gICAgICB9XG4gICAgICBkYXRhWydTZXJ2ZXInXS5mb3JFYWNoKChzZXJ2ZXJEYXRhLCBpbmRleCkgPT4ge1xuICAgICAgICBsZXQgbmV3Y29uZmlnID0gU3RvcmFnZS5nZXRTZXJ2ZXJCeU5hbWUoc2VydmVyRGF0YVsnTmFtZSddWydfdGV4dCddKTtcbiAgICAgICAgbGV0IG5ld1NlcnZlciA9IHRydWU7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBuZXdjb25maWcgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgbmV3Y29uZmlnID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShzZXJ2ZXJfY29uZmlnKSk7XG4gICAgICAgICAgY3JlYXRlZFNlcnZlcnMrKztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB1cGRhdGVkU2VydmVycysrO1xuICAgICAgICAgIG5ld1NlcnZlciA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgbmV3Y29uZmlnLm5hbWUgPSBzZXJ2ZXJEYXRhWydOYW1lJ11bJ190ZXh0J107XG4gICAgICAgIG5ld2NvbmZpZy5ob3N0ID0gc2VydmVyRGF0YVsnSG9zdCddWydfdGV4dCddO1xuICAgICAgICBpZiAodHlwZW9mIHNlcnZlckRhdGFbJ1BvcnQnXSAhPT0gJ3VuZGVmaW5lZCcpXG4gICAgICAgICAgbmV3Y29uZmlnLnBvcnQgPSBzZXJ2ZXJEYXRhWydQb3J0J11bJ190ZXh0J107XG4gICAgICAgIGlmICh0eXBlb2Ygc2VydmVyRGF0YVsnVXNlciddICE9PSAndW5kZWZpbmVkJylcbiAgICAgICAgICBuZXdjb25maWcudXNlciA9IHNlcnZlckRhdGFbJ1VzZXInXVsnX3RleHQnXTtcbiAgICAgICAgaWYgKHR5cGVvZiBzZXJ2ZXJEYXRhWydQYXNzJ10gIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgaWYgKHNlcnZlckRhdGFbJ1Bhc3MnXVsnX2F0dHJpYnV0ZXMnXVsnZW5jb2RpbmcnXSA9PSAnYmFzZTY0Jykge1xuICAgICAgICAgICAgbmV3Y29uZmlnLnBhc3N3b3JkID0gQnVmZmVyLmZyb20oc2VydmVyRGF0YVsnUGFzcyddWydfdGV4dCddLCBzZXJ2ZXJEYXRhWydQYXNzJ11bJ19hdHRyaWJ1dGVzJ11bJ2VuY29kaW5nJ10pLnRvU3RyaW5nKCk7XG4gICAgICAgICAgfSBlbHNlIGlmIChzZXJ2ZXJEYXRhWydQYXNzJ11bJ19hdHRyaWJ1dGVzJ11bJ2VuY29kaW5nJ10gPT0gJ2NyeXB0Jykge1xuICAgICAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFdhcm5pbmcoJ05vdCBpbXBsZW1lbnRlZCBpbXBvcnQgZnJvbSBGaWxlWmlsbGEhJywge1xuICAgICAgICAgICAgICBkZXRhaWw6IFwiRmlsZXppbGxhIGltcG9ydCB3aXRoIGNyeXB0ZWQgcGFzc3dvcmQgaGFzIG5vdCBiZWVuIGltcGxlbWVudGVkISBTYXZlZCBlbXB0eSBwYXNzd29yZCBmb3IgXCIgKyBuZXdjb25maWcubmFtZSArIFwiIVwiLFxuICAgICAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSBpZiAoc2VydmVyRGF0YVsnUGFzcyddWydfYXR0cmlidXRlcyddWydlbmNvZGluZyddID09ICdwbGFpbicpIHtcbiAgICAgICAgICAgIG5ld2NvbmZpZy5wYXNzd29yZCA9IHNlcnZlckRhdGFbJ1Bhc3MnXVsnX3RleHQnXSwgc2VydmVyRGF0YVsnUGFzcyddWydfYXR0cmlidXRlcyddWydlbmNvZGluZyddO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZygnTm90IHJlY29nbml6ZWQgZW5jb2RpbmcgbWV0aG9kIGZvciBwYXNzd29yZCEnLCB7XG4gICAgICAgICAgICAgIGRldGFpbDogXCJDb3VsZG4ndCByZWNvZ25pemUgcGFzc3dvcmQgdHlwZSBmb3Igc2VydmVyIFwiICsgbmV3Y29uZmlnLm5hbWUgKyBcIiBpbiBGaWxlWmlsbGEgaW1wb3J0IGZpbGUuIFNhdmVkIGVtcHR5IHBhc3N3b3JkLlwiLFxuICAgICAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBuZXdjb25maWcuc2Z0cCA9IChzZXJ2ZXJEYXRhWydQcm90b2NvbCddWydfdGV4dCddID09ICcxJyk7XG4gICAgICAgIG5ld2NvbmZpZy5yZW1vdGUgPSBzZXJ2ZXJEYXRhWydSZW1vdGVEaXInXVsnX3RleHQnXSB8fCAnJztcblxuICAgICAgICAvLyBDb252ZXJ0IEZpbGVaaWxsYSBwYXRoXG4gICAgICAgIGlmIChuZXdjb25maWcucmVtb3RlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBsZXQgcGFydHMgPSBuZXdjb25maWcucmVtb3RlLnNwbGl0KCcgJyk7XG4gICAgICAgICAgbGV0IHNlZ21lbnRzID0gWycvJ107XG5cbiAgICAgICAgICAvLyBSZW1vdmUgdHlwZSBhbmQgc3RvcFxuICAgICAgICAgIGNvbnN0IHR5cGUgPSBwYXJ0cy5zaGlmdCgpO1xuICAgICAgICAgIGNvbnN0IHN0b3AgPSBwYXJ0cy5zaGlmdCgpO1xuXG4gICAgICAgICAgLy8gcGFyc2Ugc2VnbWVudHNcbiAgICAgICAgICB3aGlsZSAocGFydHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3Qgc2VnbWVudExlbmd0aCA9IHBhcnRzLnNoaWZ0KCk7XG4gICAgICAgICAgICBzZWdtZW50cy5wdXNoKHBhcnRzLnNoaWZ0KCkpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBuZXdjb25maWcucmVtb3RlID0gbm9ybWFsaXplKHNlZ21lbnRzLmpvaW4oJy8nKSk7XG4gICAgICAgIH1cblxuICAgICAgICBuZXdjb25maWcucGFyZW50ID0gcGFyZW50O1xuICAgICAgICBpZiAobmV3U2VydmVyKSB7XG4gICAgICAgICAgU3RvcmFnZS5hZGRTZXJ2ZXIobmV3Y29uZmlnKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBkYXRhWydGb2xkZXInXSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGlmICghQXJyYXkuaXNBcnJheShkYXRhWydGb2xkZXInXSkpIHtcbiAgICAgICAgZGF0YVsnRm9sZGVyJ10gPSBbZGF0YVsnRm9sZGVyJ11dO1xuICAgICAgfVxuICAgICAgZGF0YVsnRm9sZGVyJ10uZm9yRWFjaCgoZm9sZGVyRGF0YSwgaW5kZXgpID0+IHtcbiAgICAgICAgbGV0IG5ld2NvbmZpZyA9IFN0b3JhZ2UuZ2V0Rm9sZGVyQnlOYW1lKGZvbGRlckRhdGFbJ190ZXh0J10pO1xuICAgICAgICBpZiAodHlwZW9mIG5ld2NvbmZpZyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICBuZXdjb25maWcgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGZvbGRlcl9jb25maWcpKTtcbiAgICAgICAgICBuZXdjb25maWcubmFtZSA9IGZvbGRlckRhdGFbJ190ZXh0J107XG4gICAgICAgICAgbmV3Y29uZmlnLnBhcmVudCA9IHBhcmVudDtcbiAgICAgICAgICBTdG9yYWdlLmFkZEZvbGRlcihuZXdjb25maWcpO1xuICAgICAgICAgIGNyZWF0ZWRGb2xkZXJzKys7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGltcG9ydGVkID0gc2VsZi5pbXBvcnRGaWxlWmlsbGEzKGZvbGRlckRhdGEsIG5ld2NvbmZpZy5pZCk7XG4gICAgICAgIGNyZWF0ZWRTZXJ2ZXJzICs9IGltcG9ydGVkLmNyZWF0ZWRTZXJ2ZXJzO1xuICAgICAgICB1cGRhdGVkU2VydmVycyArPSBpbXBvcnRlZC51cGRhdGVkU2VydmVycztcbiAgICAgICAgY3JlYXRlZEZvbGRlcnMgKz0gaW1wb3J0ZWQuY3JlYXRlZEZvbGRlcnM7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4geyBjcmVhdGVkU2VydmVyczogY3JlYXRlZFNlcnZlcnMsIHVwZGF0ZWRTZXJ2ZXJzOiB1cGRhdGVkU2VydmVycywgY3JlYXRlZEZvbGRlcnM6IGNyZWF0ZWRGb2xkZXJzIH07XG4gIH1cblxuICBpbXBvcnRGdHBDb25maWcoZGF0YSkge1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIGxldCBjcmVhdGVkU2VydmVycyA9IDA7XG4gICAgbGV0IHVwZGF0ZWRTZXJ2ZXJzID0gMDtcblxuICAgIGxldCBuYW1lID0gKCh0eXBlb2YgZGF0YVsndXNlciddICE9PSAndW5kZWZpbmVkJykgPyAoZGF0YVsndXNlciddICsgJ0AnKSA6ICcnKSArIGRhdGFbJ2hvc3QnXTtcbiAgICBsZXQgbmV3Y29uZmlnID0gU3RvcmFnZS5nZXRTZXJ2ZXJCeU5hbWUobmFtZSk7XG4gICAgaWYgKHR5cGVvZiBuZXdjb25maWcgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBuZXdjb25maWcgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHNlcnZlcl9jb25maWcpKTtcbiAgICAgIGNyZWF0ZWRTZXJ2ZXJzKys7XG4gICAgfSBlbHNlIHtcbiAgICAgIHVwZGF0ZWRTZXJ2ZXJzKys7XG4gICAgfVxuICAgIG5ld2NvbmZpZy5uYW1lID0gbmFtZTtcbiAgICBuZXdjb25maWcuaG9zdCA9IGRhdGFbJ2hvc3QnXTtcbiAgICBpZiAodHlwZW9mIGRhdGFbJ3BvcnQnXSAhPT0gJ3VuZGVmaW5lZCcpXG4gICAgICBuZXdjb25maWcucG9ydCA9IGRhdGFbJ3BvcnQnXTtcbiAgICBpZiAodHlwZW9mIGRhdGFbJ3VzZXInXSAhPT0gJ3VuZGVmaW5lZCcpXG4gICAgICBuZXdjb25maWcudXNlciA9IGRhdGFbJ3VzZXInXTtcbiAgICBpZiAodHlwZW9mIGRhdGFbJ3Bhc3MnXSAhPT0gJ3VuZGVmaW5lZCcpXG4gICAgICBuZXdjb25maWcucGFzc3dvcmQgPSBkYXRhWydwYXNzJ107XG4gICAgbmV3Y29uZmlnLnNmdHAgPSAoZGF0YVsncHJvdG9jb2wnXSA9PSAnc2Z0cCcpO1xuICAgIG5ld2NvbmZpZy5yZW1vdGUgPSBkYXRhWydyZW1vdGUnXTtcbiAgICBpZiAoY3JlYXRlZFNlcnZlcnMgPiAwKSB7XG4gICAgICBTdG9yYWdlLmFkZFNlcnZlcihuZXdjb25maWcpO1xuICAgIH1cblxuICAgIHJldHVybiB7IGNyZWF0ZWRTZXJ2ZXJzOiBjcmVhdGVkU2VydmVycywgdXBkYXRlZFNlcnZlcnM6IHVwZGF0ZWRTZXJ2ZXJzLCBjcmVhdGVkRm9sZGVyczogMCB9O1xuICB9XG5cbiAgaW1wb3J0UEhQU3Rvcm0oZGF0YSkge1xuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuICAgIGxldCBjcmVhdGVkU2VydmVycyA9IDA7XG4gICAgbGV0IHVwZGF0ZWRTZXJ2ZXJzID0gMDtcblxuICAgIGRhdGEuZm9yRWFjaCgoc2VydmVyRGF0YSwgaW5kZXgpID0+IHtcbiAgICAgIGxldCBuZXdjb25maWcgPSBTdG9yYWdlLmdldFNlcnZlckJ5TmFtZShzZXJ2ZXJEYXRhWydfYXR0cmlidXRlcyddWyduYW1lJ10pO1xuICAgICAgbGV0IG5ld1NlcnZlciA9IHRydWU7XG4gICAgICBpZiAodHlwZW9mIG5ld2NvbmZpZyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgbmV3Y29uZmlnID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShzZXJ2ZXJfY29uZmlnKSk7XG4gICAgICAgIGNyZWF0ZWRTZXJ2ZXJzKys7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB1cGRhdGVkU2VydmVycysrO1xuICAgICAgICBuZXdTZXJ2ZXIgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIG5ld2NvbmZpZy5uYW1lID0gc2VydmVyRGF0YVsnX2F0dHJpYnV0ZXMnXVsnbmFtZSddO1xuICAgICAgbmV3Y29uZmlnLmhvc3QgPSBzZXJ2ZXJEYXRhWydmaWxlVHJhbnNmZXInXVsnX2F0dHJpYnV0ZXMnXVsnaG9zdCddO1xuICAgICAgaWYgKHR5cGVvZiBzZXJ2ZXJEYXRhWydmaWxlVHJhbnNmZXInXVsnX2F0dHJpYnV0ZXMnXVsncG9ydCddICE9PSAndW5kZWZpbmVkJylcbiAgICAgICAgbmV3Y29uZmlnLnBvcnQgPSBzZXJ2ZXJEYXRhWydmaWxlVHJhbnNmZXInXVsnX2F0dHJpYnV0ZXMnXVsncG9ydCddO1xuICAgICAgbmV3Y29uZmlnLnNmdHAgPSAoc2VydmVyRGF0YVsnZmlsZVRyYW5zZmVyJ11bJ19hdHRyaWJ1dGVzJ11bJ2FjY2Vzc1R5cGUnXSA9PSAnU0ZUUCcpO1xuICAgICAgbmV3Y29uZmlnLnJlbW90ZSA9IHNlcnZlckRhdGFbJ2ZpbGVUcmFuc2ZlciddWydfYXR0cmlidXRlcyddWydyb290Rm9sZGVyJ10gfHwgJyc7XG4gICAgICBpZiAobmV3U2VydmVyKSB7XG4gICAgICAgIFN0b3JhZ2UuYWRkU2VydmVyKG5ld2NvbmZpZyk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4geyBjcmVhdGVkU2VydmVyczogY3JlYXRlZFNlcnZlcnMsIHVwZGF0ZWRTZXJ2ZXJzOiB1cGRhdGVkU2VydmVycywgY3JlYXRlZEZvbGRlcnM6IDAgfTtcbiAgfVxufVxubW9kdWxlLmV4cG9ydHMgPSBJbXBvcnQ7XG4iXX0=