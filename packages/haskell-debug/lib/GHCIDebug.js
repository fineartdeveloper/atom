"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const os = require("os");
const atomAPI = require("atom");
const ahu = require("atom-haskell-utils");
const interactive_process_1 = require("./interactive-process");
const os_1 = require("os");
class GHCIDebug {
    constructor(ghciCommand = 'ghci', ghciArgs = [], bufferPath) {
        this.emitter = new atomAPI.Emitter();
        this.on = this.emitter.on.bind(this.emitter);
        this.moduleNameByPath = new Map();
        this.addReadyEvent();
        this.readyPromise = this.init(ghciCommand, ghciArgs, bufferPath);
        this.readyPromise.then((response) => {
            console.warn(response.stderr.join(os_1.EOL));
        });
    }
    destroy() {
        this.stop();
    }
    async loadModule(name) {
        await this.run(`:load ${name}`);
    }
    async setExceptionBreakLevel(level) {
        await this.run(':unset -fbreak-on-exception', false, false, false, false);
        await this.run(':unset -fbreak-on-error', false, false, false, false);
        switch (level) {
            case 'exceptions':
                await this.run(':set -fbreak-on-exception', false, false, false, false);
                break;
            case 'errors':
                await this.run(':set -fbreak-on-error', false, false, false, false);
                break;
            case 'none':
                break;
        }
    }
    async addBreakpoint(breakpoint) {
        if (typeof breakpoint === 'string') {
            await this.run(`:break ${breakpoint}`);
        }
        else if (breakpoint.file) {
            try {
                const moduleName = await this.moduleNameFromFilePath(breakpoint.file);
                await this.run(`:break ${moduleName} ${breakpoint.line}`);
            }
            catch (e) {
                atom.notifications.addError(`Failed to set breakpoint on ${breakpoint.file}`, {
                    detail: e.toString(),
                    stack: e.stack,
                    dismissable: true,
                });
            }
        }
        else {
            atom.notifications.addError('Failed to set breakpoint', {
                detail: 'Text editor has no filename',
                dismissable: true,
            });
        }
    }
    async resolveExpression(expression) {
        if (!expression.trim()) {
            return undefined;
        }
        if (expression.indexOf('\n') !== -1) {
            return undefined;
        }
        const getExpression = (ghciOutput) => {
            const matchResult = ghciOutput.match(/[^ ]* = (.*)/);
            if (!matchResult) {
                return undefined;
            }
            return matchResult[1];
        };
        const printingResult = getExpression(await this.run(`:print ${expression}`, false, false, false, false));
        if (printingResult !== undefined) {
            return printingResult;
        }
        let tempVarNum = 0;
        let potentialTempVar;
        do {
            tempVarNum += 1;
            potentialTempVar = getExpression(await this.run(`:print temp${tempVarNum}`, false, false, false, false));
        } while (potentialTempVar !== undefined);
        await this.run(`let temp${tempVarNum} = ${expression}`, false, false, false, false);
        return getExpression(await this.run(`:print temp${tempVarNum}`, false, false, false, false));
    }
    forward() {
        this.run(':forward', true);
    }
    back() {
        this.run(':back', true);
    }
    step() {
        this.run(':step', true, true);
    }
    stop() {
        this.run(':quit');
        setTimeout(() => {
            this.process && this.process.destroy();
        }, 3000);
    }
    continue() {
        this.run(':continue', true);
    }
    async addedAllListeners() {
        return this.readyPromise;
    }
    async startDebug(moduleName) {
        moduleName = moduleName || 'main';
        await this.run(':trace ' + moduleName, true, true);
    }
    async run(commandText, emitStatusChanges = false, emitHistoryLength = false, emitCommandOutput = true, emitErrors = true) {
        await this.readyPromise;
        if (!this.process)
            throw new Error('No interactive process');
        let prompt = '';
        let tail = '';
        const response = await this.process.request(commandText + os_1.EOL, (arg) => {
            if (arg.type === 'stdin') {
                if (emitCommandOutput)
                    this.emitter.emit('command-issued', arg.line);
            }
            else if (arg.type === 'prompt') {
                tail = arg.prompt[1];
                prompt = arg.prompt[2];
                if (emitCommandOutput) {
                    this.emitter.emit('console-output', `${tail}${prompt}> `);
                }
            }
            else if (arg.type === 'stdout') {
                if (emitCommandOutput) {
                    this.emitter.emit('console-output', arg.line + os_1.EOL);
                }
            }
            else if (arg.type === 'stderr') {
                if (emitErrors)
                    this.emitter.emit('error', arg.line + os_1.EOL);
            }
        });
        const result = response.stdout;
        const err = response.stderr;
        if (tail)
            result.push(tail);
        if (emitErrors && err.length) {
            this.emitter.emit('error-completed', err.join(os_1.EOL));
        }
        if (emitStatusChanges) {
            await this.emitStatusChanges(prompt, result.join(os_1.EOL), emitHistoryLength);
        }
        return result.join(os_1.EOL);
    }
    async init(ghciCommand = 'ghci', ghciArgs = [], bufferPath) {
        const cwd = (await ahu.getRootDir(bufferPath || null)).getPath();
        this.process = new interactive_process_1.InteractiveProcess(ghciCommand, ghciArgs, () => {
            this.emitter.emit('debug-finished', undefined);
        }, { cwd, shell: true }, /^(.*)#~IDEHASKELLREPL~(.*)~#$/);
        return this.process.request(`:set prompt2 \"\"${os_1.EOL}` +
            `:set prompt-cont \"\"${os_1.EOL}` +
            `:set prompt \"#~IDEHASKELLREPL~%s~#\\n\"${os_1.EOL}`, (arg) => {
            if (arg.type === 'stdout') {
                this.emitter.emit('console-output', arg.line + os_1.EOL);
            }
            else if (arg.type === 'stderr') {
                this.emitter.emit('error', arg.line + os_1.EOL);
            }
            else if (arg.type === 'prompt') {
                this.emitter.emit('console-output', `${arg.prompt[1]}${arg.prompt[2]}> `);
            }
        });
    }
    addReadyEvent() {
        this.emitter.on('paused-on-exception', () => this.emitter.emit('ready', undefined));
        this.emitter.on('line-changed', () => this.emitter.emit('ready', undefined));
        this.emitter.on('debug-finished', () => this.emitter.emit('ready', undefined));
    }
    async getBindings() {
        const outputStr = await this.run(':show bindings', false, false, false);
        return outputStr.split(os.EOL);
    }
    async getHistoryLength() {
        const historyQuery = await this.run(':history 100', false, false, false);
        const regex = /-(\d*).*(?:\n|\r|\r\n)<end of history>$/;
        const matchResult = historyQuery.match(regex);
        if (!matchResult) {
            if (historyQuery.slice(-3) === '...') {
                return Infinity;
            }
            else {
                return 0;
            }
        }
        else {
            return parseInt(matchResult[1], 10);
        }
    }
    parsePrompt(stdOutput) {
        const patterns = [
            {
                pattern: /^\[(?:[-\d]*: )?(.*):\((\d+),(\d+)\)-\((\d+),(\d+)\).*\].*$/,
                func: (match) => ({
                    filename: match[1],
                    range: [
                        [parseInt(match[2], 10) - 1, parseInt(match[3], 10) - 1],
                        [parseInt(match[4], 10), parseInt(match[5], 10)],
                    ],
                }),
            },
            {
                pattern: /^\[(?:[-\d]*: )?(.*):(\d*):(\d*)-(\d*)\].*$/,
                func: (match) => ({
                    filename: match[1],
                    range: [
                        [parseInt(match[2], 10) - 1, parseInt(match[3], 10) - 1],
                        [parseInt(match[2], 10) - 1, parseInt(match[4], 10)],
                    ],
                }),
            },
            {
                pattern: /^\[<exception thrown>\].*$/,
                func: () => GHCIDebug.pausedOnError,
            },
            {
                pattern: /^.*$/,
                func: () => GHCIDebug.finishedDebugging,
            },
        ];
        for (const pattern of patterns) {
            const matchResult = stdOutput.match(pattern.pattern);
            if (matchResult) {
                return pattern.func(matchResult);
            }
        }
        throw new Error('Cannot read prompt: \n' + stdOutput);
    }
    async emitStatusChanges(prompt, mainBody, emitHistoryLength) {
        const result = this.parsePrompt(prompt);
        if (result === GHCIDebug.pausedOnError) {
            const historyLength = await this.getHistoryLength();
            this.emitter.emit('paused-on-exception', {
                historyLength,
                localBindings: mainBody.split('\n').slice(1),
            });
        }
        else if (result === GHCIDebug.finishedDebugging) {
            this.emitter.emit('debug-finished', undefined);
        }
        else {
            const breakInfo = result;
            breakInfo.localBindings = await this.getBindings();
            if (emitHistoryLength) {
                breakInfo.historyLength = await this.getHistoryLength();
            }
            this.emitter.emit('line-changed', breakInfo);
        }
    }
    async moduleNameFromFilePath(filePath) {
        const cachedModuleName = this.moduleNameByPath.get(filePath);
        if (cachedModuleName)
            return cachedModuleName;
        const modules = (await this.run(':show modules')).split(os.EOL);
        const regex = /^([^ ]+) +\( +(.+), +\w+ +\)$/;
        for (const moduleStr of modules) {
            const matchResult = regex.exec(moduleStr);
            if (matchResult) {
                this.moduleNameByPath.set(matchResult[2], matchResult[1]);
            }
            else {
                console.error(`Unexpected reply from GHCI ':show modules': ${moduleStr}`);
            }
        }
        const newCachedModuleName = this.moduleNameByPath.get(filePath);
        if (newCachedModuleName) {
            return newCachedModuleName;
        }
        else {
            throw new Error(`Couldn't find module name for ${filePath}`);
        }
    }
}
GHCIDebug.pausedOnError = Symbol('Paused on Error');
GHCIDebug.finishedDebugging = Symbol('Finished debugging');
exports.GHCIDebug = GHCIDebug;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR0hDSURlYnVnLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vbGliLXNyYy9HSENJRGVidWcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5QkFBeUI7QUFDekIsZ0NBQWdDO0FBQ2hDLDBDQUF5QztBQUN6QywrREFBMEU7QUFDMUUsMkJBQXdCO0FBcUJ4QjtJQXlCRSxZQUNFLFdBQVcsR0FBRyxNQUFNLEVBQ3BCLFdBQXFCLEVBQUUsRUFDdkIsVUFBbUI7UUF4QmIsWUFBTyxHQWFYLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBRVQsT0FBRSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7UUFJL0MscUJBQWdCLEdBQXdCLElBQUksR0FBRyxFQUFFLENBQUE7UUFPdkQsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFBO1FBQ3BCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFBO1FBRWhFLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDbEMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFHLENBQUMsQ0FBQyxDQUFBO1FBQ3pDLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVNLE9BQU87UUFDWixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUE7SUFDYixDQUFDO0lBRU0sS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFZO1FBQ2xDLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLElBQUksRUFBRSxDQUFDLENBQUE7SUFDakMsQ0FBQztJQUVNLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxLQUEyQjtRQUM3RCxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUMsNkJBQTZCLEVB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LENBQ1gsK0NBQStDLFNBQVMsRUFBRSxDQUMzRCxDQUFBO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFDRCxNQUFNLG1CQUFtQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDL0QsRUFBRSxDQUFDLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO1lBQ3hCLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQTtRQUM1QixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixNQUFNLElBQUksS0FBSyxDQUFDLGlDQUFpQyxRQUFRLEVBQUUsQ0FBQyxDQUFBO1FBQzlELENBQUM7SUFDSCxDQUFDOztBQTNYYyx1QkFBYSxHQUFHLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO0FBQ3pDLDJCQUFpQixHQUFHLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO0FBRmpFLDhCQTZYQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBvcyA9IHJlcXVpcmUoJ29zJylcbmltcG9ydCBhdG9tQVBJID0gcmVxdWlyZSgnYXRvbScpXG5pbXBvcnQgKiBhcyBhaHUgZnJvbSAnYXRvbS1oYXNrZWxsLXV0aWxzJ1xuaW1wb3J0IHsgSW50ZXJhY3RpdmVQcm9jZXNzLCBJUmVxdWVzdFJlc3VsdCB9IGZyb20gJy4vaW50ZXJhY3RpdmUtcHJvY2VzcydcbmltcG9ydCB7IEVPTCB9IGZyb20gJ29zJ1xuXG5leHBvcnQgaW50ZXJmYWNlIEJyZWFrSW5mbyB7XG4gIGZpbGVuYW1lOiBzdHJpbmdcbiAgcmFuZ2U6IFtbbnVtYmVyLCBudW1iZXJdLCBbbnVtYmVyLCBudW1iZXJdXVxuICBoaXN0b3J5TGVuZ3RoPzogbnVtYmVyXG4gIGxvY2FsQmluZGluZ3M6IHN0cmluZ1tdXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXhjZXB0aW9uSW5mbyB7XG4gIGhpc3RvcnlMZW5ndGg6IG51bWJlclxuICBsb2NhbEJpbmRpbmdzOiBzdHJpbmdbXVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEJyZWFrcG9pbnQge1xuICBsaW5lOiBudW1iZXIgLy8gMSBpcyB0aGUgZ3JlYXRlc3QgbnVtYmVyIHRoaXMgY2FuIGNvbnRhaW5cbiAgZmlsZTogc3RyaW5nIHwgdW5kZWZpbmVkIC8vIGFic29sdXRlIHBhdGhcbn1cblxuZXhwb3J0IHR5cGUgRXhjZXB0aW9uQnJlYWtMZXZlbHMgPSAnbm9uZScgfCAnZXhjZXB0aW9ucycgfCAnZXJyb3JzJ1xuXG5leHBvcnQgY2xhc3MgR0hDSURlYnVnIHtcbiAgcHJpdmF0ZSBzdGF0aWMgcGF1c2VkT25FcnJvciA9IFN5bWJvbCgnUGF1c2VkIG9uIEVycm9yJylcbiAgcHJpdmF0ZSBzdGF0aWMgZmluaXNoZWREZWJ1Z2dpbmcgPSBTeW1ib2woJ0ZpbmlzaGVkIGRlYnVnZ2luZycpXG5cbiAgcHJpdmF0ZSBlbWl0dGVyOiBhdG9tQVBJLkVtaXR0ZXI8XG4gICAge1xuICAgICAgJ2RlYnVnLWZpbmlzaGVkJzogdW5kZWZpbmVkIC8vLyBFbW1pdGVkIHdoZW4gdGhlIGRlYnVnZ2VyIGhhcyByZWFjaGVkIHRoZSBlbmQgb2YgdGhlIHByb2dyYW1cbiAgICAgIHJlYWR5OiBFeGNlcHRpb25JbmZvIHwgdW5kZWZpbmVkIC8vLyBFbW1pdGVkIHdoZW4gZ2hjaSBoYXMganVzdCBzdG9wcGVkIGV4ZWN1dGluZyBhIGNvbW1hbmRcbiAgICB9LFxuICAgIHtcbiAgICAgICdwYXVzZWQtb24tZXhjZXB0aW9uJzogRXhjZXB0aW9uSW5mbyAvLy8gRW1taXRlZCB3aGVuIHRoZSBkZWJ1Z2dlciBpcyBhdCBhbiBleGNlcHRpb25cbiAgICAgIGVycm9yOiBzdHJpbmcgLy8vIEVtbWl0ZWQgd2hlbiBzdGRlcnIgaGFzIGlucHV0XG4gICAgICAnZXJyb3ItY29tcGxldGVkJzogc3RyaW5nIC8vLyBFbW1pdGVkIHdoZW4gZ2hjaSByZXBvcnRzIGFuIGVycm9yIGZvciBhIGdpdmVuIGNvbW1hbmRcbiAgICAgICdsaW5lLWNoYW5nZWQnOiBCcmVha0luZm8gLy8vIEVtbWl0ZWQgd2hlbiB0aGUgbGluZSB0aGF0IHRoZSBkZWJ1Z2dlciBpcyBvbiBjaGFuZ2VzXG4gICAgICAnY29uc29sZS1vdXRwdXQnOiBzdHJpbmcgLy8vIEVtbWl0ZWQgd2hlbiB0aGUgZ2hjaSBoYXMgb3V0cHV0ZWQgc29tZXRoaW5nIHRvIHN0ZG91dCwgZXhjbHVkaW5nIHRoZSBleHRyYSBwcm9tcHRcbiAgICAgICdjb21tYW5kLWlzc3VlZCc6IHN0cmluZyAvLy8gRW1taXRlZCB3aGVuIGEgY29tbWFuZCBoYXMgYmVlbiBleGVjdXRlZFxuICAgIH1cbiAgPiA9IG5ldyBhdG9tQVBJLkVtaXR0ZXIoKVxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1lbWJlci1vcmRlcmluZ1xuICBwdWJsaWMgcmVhZG9ubHkgb24gPSB0aGlzLmVtaXR0ZXIub24uYmluZCh0aGlzLmVtaXR0ZXIpXG5cbiAgcHJpdmF0ZSBwcm9jZXNzPzogSW50ZXJhY3RpdmVQcm9jZXNzXG4gIHByaXZhdGUgcmVhZHlQcm9taXNlOiBQcm9taXNlPElSZXF1ZXN0UmVzdWx0PlxuICBwcml2YXRlIG1vZHVsZU5hbWVCeVBhdGg6IE1hcDxzdHJpbmcsIHN0cmluZz4gPSBuZXcgTWFwKClcblxuICBjb25zdHJ1Y3RvcihcbiAgICBnaGNpQ29tbWFuZCA9ICdnaGNpJyxcbiAgICBnaGNpQXJnczogc3RyaW5nW10gPSBbXSxcbiAgICBidWZmZXJQYXRoPzogc3RyaW5nLFxuICApIHtcbiAgICB0aGlzLmFkZFJlYWR5RXZlbnQoKVxuICAgIHRoaXMucmVhZHlQcm9taXNlID0gdGhpcy5pbml0KGdoY2lDb21tYW5kLCBnaGNpQXJncywgYnVmZmVyUGF0aClcblxuICAgIHRoaXMucmVhZHlQcm9taXNlLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICBjb25zb2xlLndhcm4ocmVzcG9uc2Uuc3RkZXJyLmpvaW4oRU9MKSlcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5zdG9wKClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBsb2FkTW9kdWxlKG5hbWU6IHN0cmluZykge1xuICAgIGF3YWl0IHRoaXMucnVuKGA6bG9hZCAke25hbWV9YClcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzZXRFeGNlcHRpb25CcmVha0xldmVsKGxldmVsOiBFeGNlcHRpb25CcmVha0xldmVscykge1xuICAgIGF3YWl0IHRoaXMucnVuKCc6dW5zZXQgLWZicmVhay1vbi1leGNlcHRpb24nLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSlcbiAgICBhd2FpdCB0aGlzLnJ1bignOnVuc2V0IC1mYnJlYWstb24tZXJyb3InLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSlcblxuICAgIHN3aXRjaCAobGV2ZWwpIHtcbiAgICAgIGNhc2UgJ2V4Y2VwdGlvbnMnOlxuICAgICAgICBhd2FpdCB0aGlzLnJ1bignOnNldCAtZmJyZWFrLW9uLWV4Y2VwdGlvbicsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlKVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAnZXJyb3JzJzpcbiAgICAgICAgYXdhaXQgdGhpcy5ydW4oJzpzZXQgLWZicmVhay1vbi1lcnJvcicsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlKVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAnbm9uZSc6IC8vIG5vLW9wXG4gICAgICAgIGJyZWFrXG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGFkZEJyZWFrcG9pbnQoYnJlYWtwb2ludDogQnJlYWtwb2ludCB8IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0eXBlb2YgYnJlYWtwb2ludCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGF3YWl0IHRoaXMucnVuKGA6YnJlYWsgJHticmVha3BvaW50fWApXG4gICAgfSBlbHNlIGlmIChicmVha3BvaW50LmZpbGUpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IG1vZHVsZU5hbWU6IHN0cmluZyA9IGF3YWl0IHRoaXMubW9kdWxlTmFtZUZyb21GaWxlUGF0aChcbiAgICAgICAgICBicmVha3BvaW50LmZpbGUsXG4gICAgICAgIClcbiAgICAgICAgYXdhaXQgdGhpcy5ydW4oYDpicmVhayAke21vZHVsZU5hbWV9ICR7YnJlYWtwb2ludC5saW5lfWApXG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcbiAgICAgICAgICBgRmFpbGVkIHRvIHNldCBicmVha3BvaW50IG9uICR7YnJlYWtwb2ludC5maWxlfWAsXG4gICAgICAgICAge1xuICAgICAgICAgICAgZGV0YWlsOiAoZSBhcyBFcnJvcikudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIHN0YWNrOiAoZSBhcyBFcnJvcikuc3RhY2ssXG4gICAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICApXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcignRmFpbGVkIHRvIHNldCBicmVha3BvaW50Jywge1xuICAgICAgICBkZXRhaWw6ICdUZXh0IGVkaXRvciBoYXMgbm8gZmlsZW5hbWUnLFxuICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgLyoqIHJlc29sdmVkIHRoZSBnaXZlbiBleHByZXNzaW9uIHVzaW5nIDpwcmludCwgcmV0dXJucyBudWxsIGlmIGl0IGlzIGludmFsaWRcbiAgICovXG4gIHB1YmxpYyBhc3luYyByZXNvbHZlRXhwcmVzc2lvbihleHByZXNzaW9uOiBzdHJpbmcpIHtcbiAgICBpZiAoIWV4cHJlc3Npb24udHJpbSgpKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgfVxuICAgIC8vIGV4cHJlc3Npb25zIGNhbid0IGhhdmUgbmV3IGxpbmVzXG4gICAgaWYgKGV4cHJlc3Npb24uaW5kZXhPZignXFxuJykgIT09IC0xKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgfVxuXG4gICAgY29uc3QgZ2V0RXhwcmVzc2lvbiA9IChnaGNpT3V0cHV0OiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnN0IG1hdGNoUmVzdWx0ID0gZ2hjaU91dHB1dC5tYXRjaCgvW14gXSogPSAoLiopLylcbiAgICAgIGlmICghbWF0Y2hSZXN1bHQpIHtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgICAgfVxuICAgICAgcmV0dXJuIG1hdGNoUmVzdWx0WzFdXG4gICAgfVxuXG4gICAgLy8gVE9ETzogZm9yIHRoZSBjb2RlIGJlbG93LCBpZ25vcmUgZXJyb3JzXG5cbiAgICAvLyB0cnkgcHJpbnRpbmcgZXhwcmVzc2lvblxuICAgIGNvbnN0IHByaW50aW5nUmVzdWx0ID0gZ2V0RXhwcmVzc2lvbihcbiAgICAgIGF3YWl0IHRoaXMucnVuKGA6cHJpbnQgJHtleHByZXNzaW9ufWAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlKSxcbiAgICApXG4gICAgaWYgKHByaW50aW5nUmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBwcmludGluZ1Jlc3VsdFxuICAgIH1cblxuICAgIC8vIGlmIHRoYXQgZmFpbHMgYXNzaWduIGl0IHRvIGEgdGVtcG9yYXJ5IHZhcmlhYmxlIGFuZCBldmFsdWF0ZSB0aGF0XG4gICAgbGV0IHRlbXBWYXJOdW0gPSAwXG4gICAgbGV0IHBvdGVudGlhbFRlbXBWYXI6IHN0cmluZyB8IHVuZGVmaW5lZFxuICAgIGRvIHtcbiAgICAgIHRlbXBWYXJOdW0gKz0gMVxuICAgICAgcG90ZW50aWFsVGVtcFZhciA9IGdldEV4cHJlc3Npb24oXG4gICAgICAgIGF3YWl0IHRoaXMucnVuKGA6cHJpbnQgdGVtcCR7dGVtcFZhck51bX1gLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSksXG4gICAgICApXG4gICAgfSB3aGlsZSAocG90ZW50aWFsVGVtcFZhciAhPT0gdW5kZWZpbmVkKVxuXG4gICAgYXdhaXQgdGhpcy5ydW4oXG4gICAgICBgbGV0IHRlbXAke3RlbXBWYXJOdW19ID0gJHtleHByZXNzaW9ufWAsXG4gICAgICBmYWxzZSxcbiAgICAgIGZhbHNlLFxuICAgICAgZmFsc2UsXG4gICAgICBmYWxzZSxcbiAgICApXG4gICAgcmV0dXJuIGdldEV4cHJlc3Npb24oXG4gICAgICBhd2FpdCB0aGlzLnJ1bihgOnByaW50IHRlbXAke3RlbXBWYXJOdW19YCwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UpLFxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyBmb3J3YXJkKCkge1xuICAgIHRoaXMucnVuKCc6Zm9yd2FyZCcsIHRydWUpXG4gIH1cblxuICBwdWJsaWMgYmFjaygpIHtcbiAgICB0aGlzLnJ1bignOmJhY2snLCB0cnVlKVxuICB9XG5cbiAgcHVibGljIHN0ZXAoKSB7XG4gICAgdGhpcy5ydW4oJzpzdGVwJywgdHJ1ZSwgdHJ1ZSlcbiAgfVxuXG4gIHB1YmxpYyBzdG9wKCkge1xuICAgIHRoaXMucnVuKCc6cXVpdCcpXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLnByb2Nlc3MgJiYgdGhpcy5wcm9jZXNzLmRlc3Ryb3koKVxuICAgIH0sIDMwMDApXG4gIH1cblxuICBwdWJsaWMgY29udGludWUoKSB7XG4gICAgdGhpcy5ydW4oJzpjb250aW51ZScsIHRydWUpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgYWRkZWRBbGxMaXN0ZW5lcnMoKSB7XG4gICAgcmV0dXJuIHRoaXMucmVhZHlQcm9taXNlXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3RhcnREZWJ1Zyhtb2R1bGVOYW1lPzogc3RyaW5nKSB7XG4gICAgbW9kdWxlTmFtZSA9IG1vZHVsZU5hbWUgfHwgJ21haW4nXG4gICAgYXdhaXQgdGhpcy5ydW4oJzp0cmFjZSAnICsgbW9kdWxlTmFtZSwgdHJ1ZSwgdHJ1ZSlcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBydW4oXG4gICAgY29tbWFuZFRleHQ6IHN0cmluZyxcbiAgICBlbWl0U3RhdHVzQ2hhbmdlczogYm9vbGVhbiA9IGZhbHNlLFxuICAgIGVtaXRIaXN0b3J5TGVuZ3RoOiBib29sZWFuID0gZmFsc2UsXG4gICAgZW1pdENvbW1hbmRPdXRwdXQ6IGJvb2xlYW4gPSB0cnVlLFxuICAgIGVtaXRFcnJvcnM6IGJvb2xlYW4gPSB0cnVlLFxuICApOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGF3YWl0IHRoaXMucmVhZHlQcm9taXNlXG4gICAgaWYgKCF0aGlzLnByb2Nlc3MpIHRocm93IG5ldyBFcnJvcignTm8gaW50ZXJhY3RpdmUgcHJvY2VzcycpXG4gICAgbGV0IHByb21wdCA9ICcnXG4gICAgbGV0IHRhaWwgPSAnJ1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLnByb2Nlc3MucmVxdWVzdChjb21tYW5kVGV4dCArIEVPTCwgKGFyZykgPT4ge1xuICAgICAgaWYgKGFyZy50eXBlID09PSAnc3RkaW4nKSB7XG4gICAgICAgIGlmIChlbWl0Q29tbWFuZE91dHB1dCkgdGhpcy5lbWl0dGVyLmVtaXQoJ2NvbW1hbmQtaXNzdWVkJywgYXJnLmxpbmUpXG4gICAgICB9IGVsc2UgaWYgKGFyZy50eXBlID09PSAncHJvbXB0Jykge1xuICAgICAgICB0YWlsID0gYXJnLnByb21wdFsxXVxuICAgICAgICBwcm9tcHQgPSBhcmcucHJvbXB0WzJdXG4gICAgICAgIGlmIChlbWl0Q29tbWFuZE91dHB1dCkge1xuICAgICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdjb25zb2xlLW91dHB1dCcsIGAke3RhaWx9JHtwcm9tcHR9PiBgKVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGFyZy50eXBlID09PSAnc3Rkb3V0Jykge1xuICAgICAgICBpZiAoZW1pdENvbW1hbmRPdXRwdXQpIHtcbiAgICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnY29uc29sZS1vdXRwdXQnLCBhcmcubGluZSArIEVPTClcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChhcmcudHlwZSA9PT0gJ3N0ZGVycicpIHtcbiAgICAgICAgaWYgKGVtaXRFcnJvcnMpIHRoaXMuZW1pdHRlci5lbWl0KCdlcnJvcicsIGFyZy5saW5lICsgRU9MKVxuICAgICAgfVxuICAgIH0pXG5cbiAgICBjb25zdCByZXN1bHQgPSByZXNwb25zZS5zdGRvdXRcbiAgICBjb25zdCBlcnIgPSByZXNwb25zZS5zdGRlcnJcblxuICAgIGlmICh0YWlsKSByZXN1bHQucHVzaCh0YWlsKVxuXG4gICAgaWYgKGVtaXRFcnJvcnMgJiYgZXJyLmxlbmd0aCkge1xuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2Vycm9yLWNvbXBsZXRlZCcsIGVyci5qb2luKEVPTCkpXG4gICAgfVxuXG4gICAgaWYgKGVtaXRTdGF0dXNDaGFuZ2VzKSB7XG4gICAgICBhd2FpdCB0aGlzLmVtaXRTdGF0dXNDaGFuZ2VzKHByb21wdCwgcmVzdWx0LmpvaW4oRU9MKSwgZW1pdEhpc3RvcnlMZW5ndGgpXG4gICAgfVxuICAgIHJldHVybiByZXN1bHQuam9pbihFT0wpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGluaXQoXG4gICAgZ2hjaUNvbW1hbmQgPSAnZ2hjaScsXG4gICAgZ2hjaUFyZ3M6IHN0cmluZ1tdID0gW10sXG4gICAgYnVmZmVyUGF0aD86IHN0cmluZyxcbiAgKSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW51bGwta2V5d29yZFxuICAgIGNvbnN0IGN3ZCA9IChhd2FpdCBhaHUuZ2V0Um9vdERpcihidWZmZXJQYXRoIHx8IG51bGwpKS5nZXRQYXRoKClcbiAgICB0aGlzLnByb2Nlc3MgPSBuZXcgSW50ZXJhY3RpdmVQcm9jZXNzKFxuICAgICAgZ2hjaUNvbW1hbmQsXG4gICAgICBnaGNpQXJncyxcbiAgICAgICgpID0+IHtcbiAgICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RlYnVnLWZpbmlzaGVkJywgdW5kZWZpbmVkKVxuICAgICAgfSxcbiAgICAgIHsgY3dkLCBzaGVsbDogdHJ1ZSB9LFxuICAgICAgL14oLiopI35JREVIQVNLRUxMUkVQTH4oLiopfiMkLyxcbiAgICApXG5cbiAgICByZXR1cm4gdGhpcy5wcm9jZXNzLnJlcXVlc3QoXG4gICAgICBgOnNldCBwcm9tcHQyIFxcXCJcXFwiJHtFT0x9YCArXG4gICAgICAgIGA6c2V0IHByb21wdC1jb250IFxcXCJcXFwiJHtFT0x9YCArXG4gICAgICAgIGA6c2V0IHByb21wdCBcXFwiI35JREVIQVNLRUxMUkVQTH4lc34jXFxcXG5cXFwiJHtFT0x9YCxcbiAgICAgIChhcmcpID0+IHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnRvdGFsaXR5LWNoZWNrXG4gICAgICAgIGlmIChhcmcudHlwZSA9PT0gJ3N0ZG91dCcpIHtcbiAgICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnY29uc29sZS1vdXRwdXQnLCBhcmcubGluZSArIEVPTClcbiAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dG90YWxpdHktY2hlY2tcbiAgICAgICAgfSBlbHNlIGlmIChhcmcudHlwZSA9PT0gJ3N0ZGVycicpIHtcbiAgICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnZXJyb3InLCBhcmcubGluZSArIEVPTClcbiAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dG90YWxpdHktY2hlY2tcbiAgICAgICAgfSBlbHNlIGlmIChhcmcudHlwZSA9PT0gJ3Byb21wdCcpIHtcbiAgICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdChcbiAgICAgICAgICAgICdjb25zb2xlLW91dHB1dCcsXG4gICAgICAgICAgICBgJHthcmcucHJvbXB0WzFdfSR7YXJnLnByb21wdFsyXX0+IGAsXG4gICAgICAgICAgKVxuICAgICAgICB9XG4gICAgICB9LFxuICAgIClcbiAgfVxuXG4gIHByaXZhdGUgYWRkUmVhZHlFdmVudCgpIHtcbiAgICB0aGlzLmVtaXR0ZXIub24oJ3BhdXNlZC1vbi1leGNlcHRpb24nLCAoKSA9PlxuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ3JlYWR5JywgdW5kZWZpbmVkKSxcbiAgICApXG4gICAgdGhpcy5lbWl0dGVyLm9uKCdsaW5lLWNoYW5nZWQnLCAoKSA9PiB0aGlzLmVtaXR0ZXIuZW1pdCgncmVhZHknLCB1bmRlZmluZWQpKVxuICAgIHRoaXMuZW1pdHRlci5vbignZGVidWctZmluaXNoZWQnLCAoKSA9PlxuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ3JlYWR5JywgdW5kZWZpbmVkKSxcbiAgICApXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldEJpbmRpbmdzKCkge1xuICAgIGNvbnN0IG91dHB1dFN0ciA9IGF3YWl0IHRoaXMucnVuKCc6c2hvdyBiaW5kaW5ncycsIGZhbHNlLCBmYWxzZSwgZmFsc2UpXG4gICAgcmV0dXJuIG91dHB1dFN0ci5zcGxpdChvcy5FT0wpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldEhpc3RvcnlMZW5ndGgoKSB7XG4gICAgY29uc3QgaGlzdG9yeVF1ZXJ5ID0gYXdhaXQgdGhpcy5ydW4oJzpoaXN0b3J5IDEwMCcsIGZhbHNlLCBmYWxzZSwgZmFsc2UpXG4gICAgY29uc3QgcmVnZXggPSAvLShcXGQqKS4qKD86XFxufFxccnxcXHJcXG4pPGVuZCBvZiBoaXN0b3J5PiQvXG5cbiAgICBjb25zdCBtYXRjaFJlc3VsdCA9IGhpc3RvcnlRdWVyeS5tYXRjaChyZWdleClcbiAgICBpZiAoIW1hdGNoUmVzdWx0KSB7XG4gICAgICBpZiAoaGlzdG9yeVF1ZXJ5LnNsaWNlKC0zKSA9PT0gJy4uLicpIHtcbiAgICAgICAgcmV0dXJuIEluZmluaXR5IC8vIGhpc3RvcnkgaXMgdmVyeSBsb25nXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gMFxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcGFyc2VJbnQobWF0Y2hSZXN1bHRbMV0sIDEwKVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VQcm9tcHQoc3RkT3V0cHV0OiBzdHJpbmcpOiBCcmVha0luZm8gfCBTeW1ib2wge1xuICAgIGNvbnN0IHBhdHRlcm5zID0gW1xuICAgICAge1xuICAgICAgICBwYXR0ZXJuOiAvXlxcWyg/OlstXFxkXSo6ICk/KC4qKTpcXCgoXFxkKyksKFxcZCspXFwpLVxcKChcXGQrKSwoXFxkKylcXCkuKlxcXS4qJC8sXG4gICAgICAgIGZ1bmM6IChtYXRjaCkgPT4gKHtcbiAgICAgICAgICBmaWxlbmFtZTogbWF0Y2hbMV0sXG4gICAgICAgICAgcmFuZ2U6IFtcbiAgICAgICAgICAgIFtwYXJzZUludChtYXRjaFsyXSwgMTApIC0gMSwgcGFyc2VJbnQobWF0Y2hbM10sIDEwKSAtIDFdLFxuICAgICAgICAgICAgW3BhcnNlSW50KG1hdGNoWzRdLCAxMCksIHBhcnNlSW50KG1hdGNoWzVdLCAxMCldLFxuICAgICAgICAgIF0sXG4gICAgICAgIH0pLFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgcGF0dGVybjogL15cXFsoPzpbLVxcZF0qOiApPyguKik6KFxcZCopOihcXGQqKS0oXFxkKilcXF0uKiQvLFxuICAgICAgICBmdW5jOiAobWF0Y2gpID0+ICh7XG4gICAgICAgICAgZmlsZW5hbWU6IG1hdGNoWzFdLFxuICAgICAgICAgIHJhbmdlOiBbXG4gICAgICAgICAgICBbcGFyc2VJbnQobWF0Y2hbMl0sIDEwKSAtIDEsIHBhcnNlSW50KG1hdGNoWzNdLCAxMCkgLSAxXSxcbiAgICAgICAgICAgIFtwYXJzZUludChtYXRjaFsyXSwgMTApIC0gMSwgcGFyc2VJbnQobWF0Y2hbNF0sIDEwKV0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSksXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBwYXR0ZXJuOiAvXlxcWzxleGNlcHRpb24gdGhyb3duPlxcXS4qJC8sXG4gICAgICAgIGZ1bmM6ICgpID0+IEdIQ0lEZWJ1Zy5wYXVzZWRPbkVycm9yLFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgcGF0dGVybjogL14uKiQvLFxuICAgICAgICBmdW5jOiAoKSA9PiBHSENJRGVidWcuZmluaXNoZWREZWJ1Z2dpbmcsXG4gICAgICB9LFxuICAgIF0gYXMgQXJyYXk8e1xuICAgICAgcGF0dGVybjogUmVnRXhwXG4gICAgICBmdW5jOiAobWF0Y2g6IHN0cmluZ1tdKSA9PiBCcmVha0luZm8gfCBTeW1ib2xcbiAgICB9PlxuICAgIGZvciAoY29uc3QgcGF0dGVybiBvZiBwYXR0ZXJucykge1xuICAgICAgY29uc3QgbWF0Y2hSZXN1bHQgPSBzdGRPdXRwdXQubWF0Y2gocGF0dGVybi5wYXR0ZXJuKVxuICAgICAgaWYgKG1hdGNoUmVzdWx0KSB7XG4gICAgICAgIHJldHVybiBwYXR0ZXJuLmZ1bmMobWF0Y2hSZXN1bHQpXG4gICAgICB9XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHJlYWQgcHJvbXB0OiBcXG4nICsgc3RkT3V0cHV0KVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBlbWl0U3RhdHVzQ2hhbmdlcyhcbiAgICBwcm9tcHQ6IHN0cmluZyxcbiAgICBtYWluQm9keTogc3RyaW5nLFxuICAgIGVtaXRIaXN0b3J5TGVuZ3RoOiBib29sZWFuLFxuICApIHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLnBhcnNlUHJvbXB0KHByb21wdClcblxuICAgIGlmIChyZXN1bHQgPT09IEdIQ0lEZWJ1Zy5wYXVzZWRPbkVycm9yKSB7XG4gICAgICBjb25zdCBoaXN0b3J5TGVuZ3RoID0gYXdhaXQgdGhpcy5nZXRIaXN0b3J5TGVuZ3RoKClcblxuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ3BhdXNlZC1vbi1leGNlcHRpb24nLCB7XG4gICAgICAgIGhpc3RvcnlMZW5ndGgsXG4gICAgICAgIGxvY2FsQmluZGluZ3M6IG1haW5Cb2R5LnNwbGl0KCdcXG4nKS5zbGljZSgxKSxcbiAgICAgIH0pXG4gICAgfSBlbHNlIGlmIChyZXN1bHQgPT09IEdIQ0lEZWJ1Zy5maW5pc2hlZERlYnVnZ2luZykge1xuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RlYnVnLWZpbmlzaGVkJywgdW5kZWZpbmVkKVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBicmVha0luZm8gPSByZXN1bHQgYXMgQnJlYWtJbmZvXG5cbiAgICAgIGJyZWFrSW5mby5sb2NhbEJpbmRpbmdzID0gYXdhaXQgdGhpcy5nZXRCaW5kaW5ncygpXG5cbiAgICAgIGlmIChlbWl0SGlzdG9yeUxlbmd0aCkge1xuICAgICAgICBicmVha0luZm8uaGlzdG9yeUxlbmd0aCA9IGF3YWl0IHRoaXMuZ2V0SGlzdG9yeUxlbmd0aCgpXG4gICAgICB9XG5cbiAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdsaW5lLWNoYW5nZWQnLCBicmVha0luZm8pXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBtb2R1bGVOYW1lRnJvbUZpbGVQYXRoKGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IGNhY2hlZE1vZHVsZU5hbWUgPSB0aGlzLm1vZHVsZU5hbWVCeVBhdGguZ2V0KGZpbGVQYXRoKVxuICAgIGlmIChjYWNoZWRNb2R1bGVOYW1lKSByZXR1cm4gY2FjaGVkTW9kdWxlTmFtZVxuICAgIGNvbnN0IG1vZHVsZXMgPSAoYXdhaXQgdGhpcy5ydW4oJzpzaG93IG1vZHVsZXMnKSkuc3BsaXQob3MuRU9MKVxuICAgIGNvbnN0IHJlZ2V4ID0gL14oW14gXSspICtcXCggKyguKyksICtcXHcrICtcXCkkL1xuICAgIGZvciAoY29uc3QgbW9kdWxlU3RyIG9mIG1vZHVsZXMpIHtcbiAgICAgIGNvbnN0IG1hdGNoUmVzdWx0ID0gcmVnZXguZXhlYyhtb2R1bGVTdHIpXG4gICAgICBpZiAobWF0Y2hSZXN1bHQpIHtcbiAgICAgICAgdGhpcy5tb2R1bGVOYW1lQnlQYXRoLnNldChtYXRjaFJlc3VsdFsyXSwgbWF0Y2hSZXN1bHRbMV0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAgIGBVbmV4cGVjdGVkIHJlcGx5IGZyb20gR0hDSSAnOnNob3cgbW9kdWxlcyc6ICR7bW9kdWxlU3RyfWAsXG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgbmV3Q2FjaGVkTW9kdWxlTmFtZSA9IHRoaXMubW9kdWxlTmFtZUJ5UGF0aC5nZXQoZmlsZVBhdGgpXG4gICAgaWYgKG5ld0NhY2hlZE1vZHVsZU5hbWUpIHtcbiAgICAgIHJldHVybiBuZXdDYWNoZWRNb2R1bGVOYW1lXG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGRuJ3QgZmluZCBtb2R1bGUgbmFtZSBmb3IgJHtmaWxlUGF0aH1gKVxuICAgIH1cbiAgfVxufVxuIl19