"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const atom_1 = require("atom");
const utils_1 = require("../utils");
tslib_1.__exportStar(require("./instance"), exports);
function consume(pluginManager, options, featureSet) {
    const { name, menu, messageTypes, events, controls, params, tooltip, } = options;
    const disp = new atom_1.CompositeDisposable();
    let messageProvider;
    if (menu) {
        const menuDisp = atom.menu.add([
            {
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: menu.label, submenu: menu.menu }],
            },
        ]);
        disp.add(menuDisp);
    }
    if (messageTypes) {
        if (featureSet.eventsReturnResults) {
            messageProvider = pluginManager.resultsDB.registerProvider();
        }
        for (const type of Object.keys(messageTypes)) {
            const opts = messageTypes[type];
            pluginManager.outputPanel.createTab(type, opts);
        }
    }
    if (events) {
        if (events.onWillSaveBuffer) {
            disp.add(registerEvent(name, pluginManager, messageProvider, events.onWillSaveBuffer, pluginManager.onWillSaveBuffer));
        }
        if (events.onDidSaveBuffer) {
            disp.add(registerEvent(name, pluginManager, messageProvider, events.onDidSaveBuffer, pluginManager.onDidSaveBuffer));
        }
        if (events.onDidStopChanging) {
            disp.add(registerEvent(name, pluginManager, messageProvider, events.onDidStopChanging, pluginManager.onDidStopChanging));
        }
    }
    if (tooltip) {
        let handler;
        let priority;
        let eventTypes;
        if (typeof tooltip === 'function') {
            handler = tooltip;
        }
        else {
            ;
            ({ handler, priority, eventTypes } = tooltip);
        }
        if (priority === undefined) {
            priority = 100;
        }
        disp.add(pluginManager.tooltipRegistry.register(name, {
            priority,
            handler,
            eventTypes,
        }));
    }
    if (controls) {
        for (const i of controls) {
            disp.add(pluginManager.outputPanel.addPanelControl(i));
        }
    }
    if (params) {
        for (const paramName of Object.keys(params)) {
            const spec = params[paramName];
            disp.add(pluginManager.configParamManager.add(name, paramName, spec));
        }
    }
    return disp;
}
exports.consume = consume;
function registerEvent(name, manager, provider, cb, reg) {
    function wrapStatus(cb) {
        return async function (buffer) {
            try {
                manager.backendStatus(name, { status: 'progress', detail: '' });
                const res = await cb(buffer);
                if (provider && Array.isArray(res))
                    provider.setMessages(res);
                manager.backendStatus(name, { status: 'ready', detail: '' });
            }
            catch (e) {
                manager.backendStatus(name, { status: 'warning', detail: `${e}` });
                console.warn(e);
            }
        };
    }
    if (Array.isArray(cb)) {
        const disp = new atom_1.CompositeDisposable();
        for (const i of cb) {
            disp.add(reg(wrapStatus(i)));
        }
        return disp;
    }
    else {
        return reg(wrapStatus(cb));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQWtFO0FBR2xFLG9DQUEwQztBQUsxQyxxREFBMEI7QUFNMUIsaUJBQ0UsYUFBNEIsRUFDNUIsT0FBaUMsRUFDakMsVUFBc0I7SUFFdEIsTUFBTSxFQUNKLElBQUksRUFDSixJQUFJLEVBQ0osWUFBWSxFQUNaLE1BQU0sRUFDTixRQUFRLEVBQ1IsTUFBTSxFQUNOLE9BQU8sR0FDUixHQUFHLE9BQU8sQ0FBQTtJQUNYLE1BQU0sSUFBSSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtJQUN0QyxJQUFJLGVBQXFDLENBQUE7SUFFekMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNULE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO1lBQzdCO2dCQUNFLEtBQUssRUFBRSx1QkFBZTtnQkFDdEIsT0FBTyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2FBQ3JEO1NBQ0YsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUNwQixDQUFDO0lBQ0QsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztRQUNqQixFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO1lBQ25DLGVBQWUsR0FBRyxhQUFhLENBQUMsU0FBUyxDQUFDLGdCQUFnQixFQUFFLENBQUE7UUFDOUQsQ0FBQztRQUVELEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdDLE1BQU0sSUFBSSxHQUFHLFlB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TSxDQUFDLElBQUksQ0FBQTtJQUNiLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDNUIsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXh0QnVmZmVyLCBDb21wb3NpdGVEaXNwb3NhYmxlLCBEaXNwb3NhYmxlIH0gZnJvbSAnYXRvbSdcblxuaW1wb3J0IHsgUGx1Z2luTWFuYWdlciB9IGZyb20gJy4uL3BsdWdpbi1tYW5hZ2VyJ1xuaW1wb3J0IHsgTUFJTl9NRU5VX0xBQkVMIH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQgKiBhcyBVUEkgZnJvbSAnYXRvbS1oYXNrZWxsLXVwaSdcbmltcG9ydCBURXZlbnRSYW5nZVR5cGUgPSBVUEkuVEV2ZW50UmFuZ2VUeXBlXG5pbXBvcnQgeyBQcm92aWRlciB9IGZyb20gJy4uL3Jlc3VsdHMtZGIvcHJvdmlkZXInO1xuXG5leHBvcnQgKiBmcm9tICcuL2luc3RhbmNlJ1xuXG5leHBvcnQgaW50ZXJmYWNlIEZlYXR1cmVTZXQge1xuICBldmVudHNSZXR1cm5SZXN1bHRzOiBib29sZWFuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25zdW1lKFxuICBwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyLFxuICBvcHRpb25zOiBVUEkuSVJlZ2lzdHJhdGlvbk9wdGlvbnMsXG4gIGZlYXR1cmVTZXQ6IEZlYXR1cmVTZXRcbik6IERpc3Bvc2FibGUge1xuICBjb25zdCB7XG4gICAgbmFtZSxcbiAgICBtZW51LFxuICAgIG1lc3NhZ2VUeXBlcyxcbiAgICBldmVudHMsXG4gICAgY29udHJvbHMsXG4gICAgcGFyYW1zLFxuICAgIHRvb2x0aXAsXG4gIH0gPSBvcHRpb25zXG4gIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIGxldCBtZXNzYWdlUHJvdmlkZXI6IFByb3ZpZGVyIHwgdW5kZWZpbmVkXG5cbiAgaWYgKG1lbnUpIHtcbiAgICBjb25zdCBtZW51RGlzcCA9IGF0b20ubWVudS5hZGQoW1xuICAgICAge1xuICAgICAgICBsYWJlbDogTUFJTl9NRU5VX0xBQkVMLFxuICAgICAgICBzdWJtZW51OiBbeyBsYWJlbDogbWVudS5sYWJlbCwgc3VibWVudTogbWVudS5tZW51IH1dLFxuICAgICAgfSxcbiAgICBdKVxuICAgIGRpc3AuYWRkKG1lbnVEaXNwKVxuICB9XG4gIGlmIChtZXNzYWdlVHlwZXMpIHtcbiAgICBpZiAoZmVhdHVyZVNldC5ldmVudHNSZXR1cm5SZXN1bHRzKSB7XG4gICAgICBtZXNzYWdlUHJvdmlkZXIgPSBwbHVnaW5NYW5hZ2VyLnJlc3VsdHNEQi5yZWdpc3RlclByb3ZpZGVyKClcbiAgICB9XG4gICAgLy8gVE9ETzogbWFrZSBkaXNwb3NhYmxlXG4gICAgZm9yIChjb25zdCB0eXBlIG9mIE9iamVjdC5rZXlzKG1lc3NhZ2VUeXBlcykpIHtcbiAgICAgIGNvbnN0IG9wdHMgPSBtZXNzYWdlVHlwZXNbdHlwZV1cbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgICAgcGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5jcmVhdGVUYWIodHlwZSwgb3B0cylcbiAgICB9XG4gIH1cbiAgaWYgKGV2ZW50cykge1xuICAgIGlmIChldmVudHMub25XaWxsU2F2ZUJ1ZmZlcikge1xuICAgICAgZGlzcC5hZGQoXG4gICAgICAgIHJlZ2lzdGVyRXZlbnQoXG4gICAgICAgICAgbmFtZSxcbiAgICAgICAgICBwbHVnaW5NYW5hZ2VyLFxuICAgICAgICAgIG1lc3NhZ2VQcm92aWRlcixcbiAgICAgICAgICBldmVudHMub25XaWxsU2F2ZUJ1ZmZlcixcbiAgICAgICAgICBwbHVnaW5NYW5hZ2VyLm9uV2lsbFNhdmVCdWZmZXIsXG4gICAgICAgICksXG4gICAgICApXG4gICAgfVxuICAgIGlmIChldmVudHMub25EaWRTYXZlQnVmZmVyKSB7XG4gICAgICBkaXNwLmFkZChcbiAgICAgICAgcmVnaXN0ZXJFdmVudChcbiAgICAgICAgICBuYW1lLFxuICAgICAgICAgIHBsdWdpbk1hbmFnZXIsXG4gICAgICAgICAgbWVzc2FnZVByb3ZpZGVyLFxuICAgICAgICAgIGV2ZW50cy5vbkRpZFNhdmVCdWZmZXIsXG4gICAgICAgICAgcGx1Z2luTWFuYWdlci5vbkRpZFNhdmVCdWZmZXIsXG4gICAgICAgICksXG4gICAgICApXG4gICAgfVxuICAgIGlmIChldmVudHMub25EaWRTdG9wQ2hhbmdpbmcpIHtcbiAgICAgIGRpc3AuYWRkKFxuICAgICAgICByZWdpc3RlckV2ZW50KFxuICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgcGx1Z2luTWFuYWdlcixcbiAgICAgICAgICBtZXNzYWdlUHJvdmlkZXIsXG4gICAgICAgICAgZXZlbnRzLm9uRGlkU3RvcENoYW5naW5nLFxuICAgICAgICAgIHBsdWdpbk1hbmFnZXIub25EaWRTdG9wQ2hhbmdpbmcsXG4gICAgICAgICksXG4gICAgICApXG4gICAgfVxuICB9XG4gIGlmICh0b29sdGlwKSB7XG4gICAgbGV0IGhhbmRsZXI6IFVQSS5UVG9vbHRpcEhhbmRsZXJcbiAgICBsZXQgcHJpb3JpdHk6IG51bWJlciB8IHVuZGVmaW5lZFxuICAgIGxldCBldmVudFR5cGVzOiBURXZlbnRSYW5nZVR5cGVbXSB8IHVuZGVmaW5lZFxuICAgIGlmICh0eXBlb2YgdG9vbHRpcCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgaGFuZGxlciA9IHRvb2x0aXBcbiAgICB9IGVsc2Uge1xuICAgICAgOyh7IGhhbmRsZXIsIHByaW9yaXR5LCBldmVudFR5cGVzIH0gPSB0b29sdGlwKVxuICAgIH1cbiAgICBpZiAocHJpb3JpdHkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcHJpb3JpdHkgPSAxMDBcbiAgICB9XG4gICAgZGlzcC5hZGQoXG4gICAgICBwbHVnaW5NYW5hZ2VyLnRvb2x0aXBSZWdpc3RyeS5yZWdpc3RlcihuYW1lLCB7XG4gICAgICAgIHByaW9yaXR5LFxuICAgICAgICBoYW5kbGVyLFxuICAgICAgICBldmVudFR5cGVzLFxuICAgICAgfSksXG4gICAgKVxuICB9XG4gIGlmIChjb250cm9scykge1xuICAgIGZvciAoY29uc3QgaSBvZiBjb250cm9scykge1xuICAgICAgZGlzcC5hZGQocGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5hZGRQYW5lbENvbnRyb2woaSkpXG4gICAgfVxuICB9XG4gIGlmIChwYXJhbXMpIHtcbiAgICBmb3IgKGNvbnN0IHBhcmFtTmFtZSBvZiBPYmplY3Qua2V5cyhwYXJhbXMpKSB7XG4gICAgICBjb25zdCBzcGVjID0gcGFyYW1zW3BhcmFtTmFtZV1cbiAgICAgIGRpc3AuYWRkKHBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLmFkZChuYW1lLCBwYXJhbU5hbWUsIHNwZWMpKVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiBkaXNwXG59XG5cbmZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnQoXG4gIG5hbWU6IHN0cmluZyxcbiAgbWFuYWdlcjogUGx1Z2luTWFuYWdlcixcbiAgcHJvdmlkZXI6IFByb3ZpZGVyIHwgdW5kZWZpbmVkLFxuICBjYjogVVBJLlRTaW5nbGVPckFycmF5PFVQSS5UVGV4dEJ1ZmZlckNhbGxiYWNrPixcbiAgcmVnOiAoY2I6IFVQSS5UVGV4dEJ1ZmZlckNhbGxiYWNrKSA9PiBEaXNwb3NhYmxlLFxuKSB7XG4gIGZ1bmN0aW9uIHdyYXBTdGF0dXMoY2I6IFVQSS5UVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIGFzeW5jIGZ1bmN0aW9uKGJ1ZmZlcjogVGV4dEJ1ZmZlcikge1xuICAgICAgdHJ5IHtcbiAgICAgICAgbWFuYWdlci5iYWNrZW5kU3RhdHVzKG5hbWUsIHsgc3RhdHVzOiAncHJvZ3Jlc3MnLCBkZXRhaWw6ICcnIH0pXG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGNiKGJ1ZmZlcilcbiAgICAgICAgaWYgKHByb3ZpZGVyICYmIEFycmF5LmlzQXJyYXkocmVzKSkgcHJvdmlkZXIuc2V0TWVzc2FnZXMocmVzKVxuICAgICAgICBtYW5hZ2VyLmJhY2tlbmRTdGF0dXMobmFtZSwgeyBzdGF0dXM6ICdyZWFkeScsIGRldGFpbDogJycgfSlcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbWFuYWdlci5iYWNrZW5kU3RhdHVzKG5hbWUsIHsgc3RhdHVzOiAnd2FybmluZycsIGRldGFpbDogYCR7ZX1gIH0pXG4gICAgICAgIGNvbnNvbGUud2FybihlKVxuICAgICAgfVxuICAgIH1cbiAgfVxuICBpZiAoQXJyYXkuaXNBcnJheShjYikpIHtcbiAgICBjb25zdCBkaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIGZvciAoY29uc3QgaSBvZiBjYikge1xuICAgICAgZGlzcC5hZGQocmVnKHdyYXBTdGF0dXMoaSkpKVxuICAgIH1cbiAgICByZXR1cm4gZGlzcFxuICB9IGVsc2Uge1xuICAgIHJldHVybiByZWcod3JhcFN0YXR1cyhjYikpXG4gIH1cbn1cbiJdfQ==